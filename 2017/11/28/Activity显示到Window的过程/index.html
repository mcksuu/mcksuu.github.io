<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Nick, Ksuu" />








  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.png?v=5.1.0" />






<meta name="description" content="&amp;#x434;&amp;#xFFFD;&amp;#xFFFD;&amp;#x1F0;&amp;#xFFFD;&amp;#xFFFD;&amp;#xFFFD;&amp;#x13B;&amp;#xFFFD;
&amp;#xFFFD;&amp;#xFFFD;&amp;#xFFFD;&amp;#xCFF4;&amp;#xFFFD;&amp;#xFFFD;&amp;#x4BB;&amp;#xFFFD;&amp;#xFFFD;&amp;#xFFFD;&amp;#xFFFD;&amp;#xFFFD;&amp;#x163;&amp;#xFFFD;&amp;#xFFFD;&amp;#xFFFD;&amp;#xF">
<meta property="og:type" content="article">
<meta property="og:title" content="Activity��ʾ��Window�Ĺ���">
<meta property="og:url" content="https://mcksuu.github.io/2017/11/28/Activity显示到Window的过程/index.html">
<meta property="og:site_name" content="McKsuu">
<meta property="og:description" content="&amp;#x434;&amp;#xFFFD;&amp;#xFFFD;&amp;#x1F0;&amp;#xFFFD;&amp;#xFFFD;&amp;#xFFFD;&amp;#x13B;&amp;#xFFFD;
&amp;#xFFFD;&amp;#xFFFD;&amp;#xFFFD;&amp;#xCFF4;&amp;#xFFFD;&amp;#xFFFD;&amp;#x4BB;&amp;#xFFFD;&amp;#xFFFD;&amp;#xFFFD;&amp;#xFFFD;&amp;#xFFFD;&amp;#x163;&amp;#xFFFD;&amp;#xFFFD;&amp;#xFFFD;&amp;#xF">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/5720362-2d07e73a0383c584.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/5720362-41569c08700139d7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/5720362-28ce1fb057e1ca1a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:updated_time" content="2017-11-28T13:50:05.019Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Activity��ʾ��Window�Ĺ���">
<meta name="twitter:description" content="&amp;#x434;&amp;#xFFFD;&amp;#xFFFD;&amp;#x1F0;&amp;#xFFFD;&amp;#xFFFD;&amp;#xFFFD;&amp;#x13B;&amp;#xFFFD;
&amp;#xFFFD;&amp;#xFFFD;&amp;#xFFFD;&amp;#xCFF4;&amp;#xFFFD;&amp;#xFFFD;&amp;#x4BB;&amp;#xFFFD;&amp;#xFFFD;&amp;#xFFFD;&amp;#xFFFD;&amp;#xFFFD;&amp;#x163;&amp;#xFFFD;&amp;#xFFFD;&amp;#xFFFD;&amp;#xF">
<meta name="twitter:image" content="http://upload-images.jianshu.io/upload_images/5720362-2d07e73a0383c584.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://mcksuu.github.io/2017/11/28/Activity显示到Window的过程/"/>





  <title> Activity��ʾ��Window�Ĺ��� | McKsuu </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">McKsuu</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle">McKsuu</p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://mcksuu.github.io/2017/11/28/Activity显示到Window的过程/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Nick Kang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/favicon.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="McKsuu">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="McKsuu" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Activity��ʾ��Window�Ĺ���
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="post.created" itemprop="dateCreated datePublished" datetime="2017-11-28T21:51:30+08:00">
                2017-11-28
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="&#x434;&#xFFFD;&#xFFFD;j&#xFFFD;&#xFFFD;&#xFFFD;L&#xFFFD;"><a href="#&#x434;&#xFFFD;&#xFFFD;j&#xFFFD;&#xFFFD;&#xFFFD;L&#xFFFD;" class="headerlink" title="&#x434;&#xFFFD;&#xFFFD;&#x1F0;&#xFFFD;&#xFFFD;&#xFFFD;&#x13B;&#xFFFD;"></a>&#x434;&#xFFFD;&#xFFFD;&#x1F0;&#xFFFD;&#xFFFD;&#xFFFD;&#x13B;&#xFFFD;</h1><blockquote>
<p>&#xFFFD;&#xFFFD;&#xFFFD;&#xCFF4;&#xFFFD;&#xFFFD;&#x4BB;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x163;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x3FA;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x5B5;&#x133;&#xFFFD;&#xFFFD;&#xFFFD;&#x531;&#x434;&#xFFFD;&#xFFFD;&#x5E2;&#xFFFD;&#x361;&#xFFFD;<br><img src="http://upload-images.jianshu.io/upload_images/5720362-2d07e73a0383c584.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""><br>&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x37C;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x2E3;&#xFFFD;&#x37B;&#x23B;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x3F4;&#xFFFD;&#xFFFD;&#xFFFD;&#x4F0;&#xFFFD;&#xFFFD;&#xFFFD;&#xA3;&#xFFFD;&#xFFFD;&#x4B5;&#xFFFD;Log&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x47E;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;fxxk&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xE3;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xE1;&#xFFFD;&#x4AA;&#xFFFD;&#x135;&#x123;&#xFFFD;&#xFFFD;&#x138;&#x138;&#x121;&#xFFFD;<br><img src="http://upload-images.jianshu.io/upload_images/5720362-41569c08700139d7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
</blockquote>
<hr>
<h1 id="1-&#xFFFD;&#xFFFD;WindowManager&#xFFFD;&#xFFFD;addView&#x2F5;&#xFFFD;&#xFFFD;"><a href="#1-&#xFFFD;&#xFFFD;WindowManager&#xFFFD;&#xFFFD;addView&#x2F5;&#xFFFD;&#xFFFD;" class="headerlink" title="1. &#xFFFD;&#xFFFD;WindowManager&#xFFFD;&#xFFFD;addView&#x2F5;&#xFFFD;&#xFFFD;"></a>1. &#xFFFD;&#xFFFD;WindowManager&#xFFFD;&#xFFFD;addView&#x2F5;&#xFFFD;&#xFFFD;</h1><blockquote>
<p>&#xFFFD;&#x3F4;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x1F4;&#xFFFD;&#xFFFD;&#xB7;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;Activity&#xFFFD;&#x4F4;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x2BE;&#xFFFD;&#x139;&#xFFFD;&#xFFFD;&#x323;&#xFFFD;&#xFFFD;&#xFFFD;&#x2B1;&#x5BB;&#xFFFD;&#x1FC;&#xB5977;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xA1;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x575;&#xFFFD;&#xFFFD;&#xFFFD;&#x2BE;&#xFFFD;&#xFFFD;&#xFFFD;&#x33B;&#xFFFD;&#xFFFD;&#xFFFD;&#x368;&#xFFFD;&#xFFFD;WindowManager&#xFFFD;&#xFFFD;addView&#xFFFD;&#xFFFD;&#xFFFD;&#x4F5;&#xFFFD;Window&#xFFFD;&#x3F5;&#x121;&#xFFFD;WindowManager&#xFFFD;&#x1F8;&#xFFFD;&#xFFFD;&#x4FF;&#x6A3;&#xFFFD;&#xFFFD;&#x333;&#xFFFD;&#xFFFD;&#xFFFD;ViewManager&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x575;&#xFFFD;&#x2B5;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;WindowManagerImpl&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;WindowManagerImpl&#xFFFD;&#xFFFD;addView&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">ActivityThread.java</div><div class="line">if (a.mVisibleFromClient &amp;&amp; !a.mWindowAdded) {</div><div class="line">	a.mWindowAdded = true;</div><div class="line">	wm.addView(decor, l);</div><div class="line">}</div><div class="line">WindowManagerImpl.java</div><div class="line">@Override</div><div class="line">public void addView(@NonNull View view, @NonNull ViewGroup.LayoutParams params) {</div><div class="line">	applyDefaultToken(params);</div><div class="line">	//&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;WindowManagerGlobal&#xFFFD;&#xFFFD;addView&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">	mGlobal.addView(view, params, mContext.getDisplay(), mParentWindow);</div><div class="line">}</div><div class="line">private void applyDefaultToken(@NonNull ViewGroup.LayoutParams params) {</div><div class="line">	// Only use the default token if we don&apos;t have a parent window.</div><div class="line">	if (mDefaultToken != null &amp;&amp; mParentWindow == null) {</div><div class="line">		//&#xFFFD;&#x436;&#xFFFD;params</div><div class="line">		if (!(params instanceof WindowManager.LayoutParams)) {</div><div class="line">			throw new IllegalArgumentException(&quot;Params must be WindowManager.LayoutParams&quot;);</div><div class="line">		}</div><div class="line"></div><div class="line">		// Only use the default token if we don&apos;t already have a token.</div><div class="line">		//&#xFFFD;&#xFFFD;params&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;token</div><div class="line">		final WindowManager.LayoutParams wparams = (WindowManager.LayoutParams) params;</div><div class="line">		if (wparams.token == null) {</div><div class="line">			wparams.token = mDefaultToken;</div><div class="line">		}</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure></p>
<p>&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x134;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x238;&#xFFFD;&#xFFFD;&#xFFFD;&#x1F0;&#xFFFD;&#xFFFD;params&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;token&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x175;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;WindowManagerGlobal&#xFFFD;&#xFFFD;<code>addView</code>&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</p>
</blockquote>
<hr>
<h1 id="2-WindowManagerGlobal&#xFFFD;&#xFFFD;addView&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;"><a href="#2-WindowManagerGlobal&#xFFFD;&#xFFFD;addView&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;" class="headerlink" title="2. WindowManagerGlobal&#xFFFD;&#xFFFD;addView&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;"></a>2. WindowManagerGlobal&#xFFFD;&#xFFFD;addView&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</h1><blockquote>
<p>&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x2F5;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x1F6;&#x535;&#xFFFD;&#x1F0;&#xFFFD;&#xFFFD;params&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;token&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;WindowManagerGlobal&#xFFFD;&#xFFFD;<code>addView</code>&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;<br>&#xFFFD;&#xFFFD;WindowManagerGlobal&#xFFFD;&#xFFFD;addView&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x423;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x23D;&#xFFFD;&#xFFFD;&#x435;&#xFFFD;&#xFFFD;&#x1F6;&#x532;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x423;&#xFFFD;&#x98EC;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x53C;&#xFFFD;null&#xFFFD;&#xFFFD;&#x423;&#xFFFD;&#x9863;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x368;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;throw Exception&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x6BB;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;view&#xFFFD;&#xFFFD;&#x225;&#x470;&#xFFFD;&#x4B5;&#xFFFD;&#x1F0;&#xFFFD;&#xFFFD;decorView&#xFFFD;&#x1F7;&#xFFFD;&#xFFFD;&#x47E;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x6A3;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x47E;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x4AA;&#xFFFD;&#x436;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x1F7;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x6A1;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x1E3;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x5F3;&#xFFFD;&#xFFFD;&#xCCE3;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x4AA;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;LayoutParams&#xFFFD;&#xFFFD;type&#xFFFD;&#xFFFD;&#xFFFD;&#x436;&#x3F4;&#xFFFD;&#xFFFD;&#x6B5;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x363;&#xFFFD;&#x12C;&#xFFFD;&#x3F5;&#xFFFD;&#xFFFD;&#xFFFD;<strong>TYPE_APPLICATION</strong>&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x368;&#x4E6;&#xFFFD;&#xF4;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x361;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x4F4;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x363;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x4AA;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;token&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x4E38;&#xFFFD;&#xFFFD;&#xFFFD;&#x6A1;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x4AA;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;ViewRootImpl&#xFFFD;&#xFFFD;&#xFFFD;&#xE3B32;&#xFFFD;&#xFFFD;&#xFFFD;decorView&#xFFFD;&#xFFFD;root&#xFFFD;&#xFFFD;wparams&#xFFFD;&#x53C;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x4F5;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x421;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x1F4;&#xFFFD;&#xFFFD;&#xB8FA;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div></pre></td><td class="code"><pre><div class="line">WindowManagerGlobal.java</div><div class="line">public void addView(View view, ViewGroup.LayoutParams params,</div><div class="line">		Display display, Window parentWindow) {</div><div class="line">	//&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">	if (view == null) {</div><div class="line">		throw new IllegalArgumentException(&quot;view must not be null&quot;);</div><div class="line">	}</div><div class="line">	if (display == null) {</div><div class="line">		throw new IllegalArgumentException(&quot;display must not be null&quot;);</div><div class="line">	}</div><div class="line">	if (!(params instanceof WindowManager.LayoutParams)) {</div><div class="line">		throw new IllegalArgumentException(&quot;Params must be WindowManager.LayoutParams&quot;);</div><div class="line">	}</div><div class="line"></div><div class="line">	final WindowManager.LayoutParams wparams = (WindowManager.LayoutParams) params;</div><div class="line">	if (parentWindow != null) {</div><div class="line">		parentWindow.adjustLayoutParamsForSubWindow(wparams);</div><div class="line">	} else {</div><div class="line">		// If there&apos;s no parent, then hardware acceleration for this view is</div><div class="line">		// set from the application&apos;s hardware acceleration setting.</div><div class="line">		final Context context = view.getContext();</div><div class="line">		if (context != null</div><div class="line">				&amp;&amp; (context.getApplicationInfo().flags</div><div class="line">						&amp; ApplicationInfo.FLAG_HARDWARE_ACCELERATED) != 0) {</div><div class="line">			wparams.flags |= WindowManager.LayoutParams.FLAG_HARDWARE_ACCELERATED;</div><div class="line">		}</div><div class="line">	}</div><div class="line">	</div><div class="line">	ViewRootImpl root;</div><div class="line">	View panelParentView = null;</div><div class="line"></div><div class="line">	synchronized (mLock) {</div><div class="line">		//&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x3F5;&#x373;&#xFFFD;&#xFFFD;&#xFFFD;&#x538;&#x131;&#xFFFD;&#xFFFD;&#xFFFD;callback</div><div class="line">		// Start watching for system property changes.</div><div class="line">		if (mSystemPropertyUpdater == null) {</div><div class="line">			mSystemPropertyUpdater = new Runnable() {</div><div class="line">				@Override public void run() {</div><div class="line">					synchronized (mLock) {</div><div class="line">						for (int i = mRoots.size() - 1; i &gt;= 0; --i) {</div><div class="line">							mRoots.get(i).loadSystemProperties();</div><div class="line">						}</div><div class="line">					}</div><div class="line">				}</div><div class="line">			};</div><div class="line">			SystemProperties.addChangeCallback(mSystemPropertyUpdater);</div><div class="line">		}</div><div class="line">		//&#xFFFD;&#x4FB;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;view&#xFFFD;&#xFFFD;&#x470;&#xFFFD;&#xFFFD;&#xFFFD;&#x1F7;&#xFFFD;&#xFFFD;&#xFFFD;&#x1F0;&#xFFFD;&#xFFFD;decorView&#xFFFD;&#x47E;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">		int index = findViewLocked(view, false);</div><div class="line">		//index &gt;= 0 &#xFFFD;&#xFFFD;&#x2F5;&#xFFFD;&#xFFFD;&#xFFFD;&#x47E;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x2E3;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x4AA;&#x225;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">		if (index &gt;= 0) {</div><div class="line">			//&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x675;&#xFFFD;view&#xFFFD;&#xFFFD;&#xFFFD;&#x1F7;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x435;&#x13B;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;doDie()&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">			if (mDyingViews.contains(view)) {</div><div class="line">				// Don&apos;t wait for MSG_DIE to make it&apos;s way through root&apos;s queue.</div><div class="line">				mRoots.get(index).doDie();</div><div class="line">			} else {</div><div class="line">				//&#xFFFD;&#x5F3;&#xFFFD;&#xFFFD;&#xCCE3;</div><div class="line">				throw new IllegalStateException(&quot;View &quot; + view</div><div class="line">						+ &quot; has already been added to the window manager.&quot;);</div><div class="line">			}</div><div class="line">			// The previous removeView() had not completed executing. Now it has.</div><div class="line">		}</div><div class="line"></div><div class="line">		// If this is a panel window, then find the window it is being</div><div class="line">		// attached to for future reference.</div><div class="line">		// &#xFFFD;&#x436;&#x3F5;&#xFFFD;&#x1F0;&#xFFFD;&#xFFFD;LayoutParams&#xFFFD;&#xFFFD;type&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x363;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x4F4;&#xFFFD;&#xFFFD;&#x6A3;&#xFFFD;&#xFFFD;&#xFFFD;&#xF4;&#xFFFD;&#xFFFD;&#x4AA;&#x225;&#xFFFD;&#x4B5;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x138;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">		if (wparams.type &gt;= WindowManager.LayoutParams.FIRST_SUB_WINDOW &amp;&amp;</div><div class="line">				wparams.type &lt;= WindowManager.LayoutParams.LAST_SUB_WINDOW) {</div><div class="line">			final int count = mViews.size();</div><div class="line">			for (int i = 0; i &lt; count; i++) {</div><div class="line">				if (mRoots.get(i).mWindow.asBinder() == wparams.token) {</div><div class="line">					panelParentView = mViews.get(i);</div><div class="line">				}</div><div class="line">			}</div><div class="line">		}</div><div class="line">		//&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;ViewRootImpl</div><div class="line">		root = new ViewRootImpl(view.getContext(), display);</div><div class="line">		//&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;LayoutParams</div><div class="line">		view.setLayoutParams(wparams);</div><div class="line">		//&#xFFFD;&#xFFFD;&#xFFFD;&#x4F5;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">		mViews.add(view);</div><div class="line">		mRoots.add(root);</div><div class="line">		mParams.add(wparams);</div><div class="line">	}</div><div class="line"></div><div class="line">	// do this last because it fires off messages to start doing things</div><div class="line">	try {</div><div class="line">		//&#x368;&#xFFFD;&#xFFFD;ViewRootImpl&#x225;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;view&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;decorView&#xFFFD;&#xFFFD;LayoutParams&#xFFFD;&#x53C;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">		root.setView(view, wparams, panelParentView);</div><div class="line">	} catch (RuntimeException e) {</div><div class="line">		// BadTokenException or InvalidDisplayException, clean up.</div><div class="line">		synchronized (mLock) {</div><div class="line">			final int index = findViewLocked(view, false);</div><div class="line">			if (index &gt;= 0) {</div><div class="line">				removeViewLocked(index, true);</div><div class="line">			}</div><div class="line">		}</div><div class="line">		throw e;</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure></p>
</blockquote>
<hr>
<h1 id="3-ViewRootImpl&#xFFFD;&#xFFFD;setView&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;"><a href="#3-ViewRootImpl&#xFFFD;&#xFFFD;setView&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;" class="headerlink" title="3. ViewRootImpl&#xFFFD;&#xFFFD;setView&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;"></a>3. ViewRootImpl&#xFFFD;&#xFFFD;setView&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</h1><blockquote>
<p>ViewRootImpl&#xFFFD;&#xFFFD;setView&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x23D;&#x3F3;&#xFFFD;&#xFFFD;&#xFFFD;&#x1F0;&#x4BB;&#xFFFD;&#xFFFD;&#xFFFD;&#x5B2;&#xFFFD;&#xFFFD;&#xF6;&#xFFFD;&#x2F5;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x4BB;&#xFFFD;&#xFFFD;&#xFFFD;&#x5B1;&#x23D;&#xFFFD;&#xFFFD;&#xFFFD;&#x4AA;&#xFFFD;&#xFFFD;&#xFFFD;&#x1F6;&#xFFFD;<code>mSurfaceHolderCallback</code>&#xFFFD;&#x138;&#xFFFD;&#x5B5;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x4AA;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;<code>DecorView extends FrameLayout implements RootViewSurfaceTaker</code>&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;willYouTakeTheSurface&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x635;&#xFFFD;&#x12C;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;null&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x4AA;&#xFFFD;&#xFFFD;&#xFFFD;&#xFF;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;Activity&#xFFFD;&#xFFFD;&#x2B9;&#xFFFD;&#xFFFD;<code>getWindow().takeSurface()</code>&#xFFFD;&#xFFFD;&#xFFFD;&#xE1;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x175;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;<code>requestLayout()</code>&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x225;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x2BC;&#xFFFD;&#xFFFD;&#xFFFD;&#x5A3;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x368;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;Choreographer&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x435;&#xFFFD;&#xFFFD;&#xCCBD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x4B2;&#xFFFD;&#x23D;&#x3F7;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x1F6;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x368;&#xFFFD;&#xFFFD;&#xFFFD;&#x13D;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x368;&#xFFFD;&#xFFFD;Session&#xFFFD;&#xFFFD;IWindow&#xFFFD;&#xFFFD;&#xFFFD;&#x4F5;&#xFFFD;WMS&#xFFFD;&#x421;&#xFFFD;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div></pre></td><td class="code"><pre><div class="line">public void setView(View view, WindowManager.LayoutParams attrs, View panelParentView) {</div><div class="line">	synchronized (this) {</div><div class="line">		if (mView == null) {</div><div class="line">			mView = view;</div><div class="line"></div><div class="line">			mAttachInfo.mDisplayState = mDisplay.getState();</div><div class="line">			mDisplayManager.registerDisplayListener(mDisplayListener, mHandler);</div><div class="line"></div><div class="line">			mViewLayoutDirectionInitial = mView.getRawLayoutDirection();</div><div class="line">			mFallbackEventHandler.setView(view);</div><div class="line">			mWindowAttributes.copyFrom(attrs);</div><div class="line">			if (mWindowAttributes.packageName == null) {</div><div class="line">				mWindowAttributes.packageName = mBasePackageName;</div><div class="line">			}</div><div class="line">			attrs = mWindowAttributes;</div><div class="line">			setTag();</div><div class="line"></div><div class="line">			// Keep track of the actual window flags supplied by the client.</div><div class="line">			mClientWindowLayoutFlags = attrs.flags;</div><div class="line"></div><div class="line">			setAccessibilityFocus(null, null);</div><div class="line">			//&#xFFFD;&#xFFFD;&#x1F0;&#xFFFD;&#xFFFD;view&#xFFFD;&#xFFFD;decorView&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x368;&#xFFFD;&#xFFFD;&#x534;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x53F;&#xFFFD;&#xFFFD;&#xFFFD;	DecorView extends FrameLayout implements RootViewSurfaceTaker, WindowCallbacks</div><div class="line">			//&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;willYouTakeTheSurface&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x225;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;Callback2&#xFFFD;&#xFFFD;&#x2B1;&#xFFFD;&#xFFFD;</div><div class="line">			//&#x2B5;&#xFFFD;&#xFFFD;&#xFFFD;&#x3FB;&#xFFFD;&#x221;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;PhoneWindow&#xFFFD;&#xFFFD;mTakeSurfaceCallback&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;mTakeSurfaceCallback&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x368;&#xFFFD;&#xFFFD;getWindow().takeSurface()&#xFFFD;&#xFFFD;&#xFFFD;&#x5B7;&#xFFFD;&#x2BD;&#xFFFD;&#xFFFD;&#xFFFD;&#xE1;&#xFFFD;</div><div class="line">			if (view instanceof RootViewSurfaceTaker) {</div><div class="line">				//&#x12C;&#xFFFD;&#x3F5;&#xFFFD;&#x3AA;null</div><div class="line">				mSurfaceHolderCallback =</div><div class="line">						((RootViewSurfaceTaker)view).willYouTakeTheSurface();</div><div class="line">				if (mSurfaceHolderCallback != null) {</div><div class="line">					mSurfaceHolder = new TakenSurfaceHolder();</div><div class="line">					mSurfaceHolder.setFormat(PixelFormat.UNKNOWN);</div><div class="line">				}</div><div class="line">			}</div><div class="line"></div><div class="line">			// Compute surface insets required to draw at specified Z value.</div><div class="line">			// TODO: Use real shadow insets for a constant max Z.</div><div class="line">			if (!attrs.hasManualSurfaceInsets) {</div><div class="line">				attrs.setSurfaceInsets(view, false /*manual*/, true /*preservePrevious*/);</div><div class="line">			}</div><div class="line"></div><div class="line">			CompatibilityInfo compatibilityInfo =</div><div class="line">					mDisplay.getDisplayAdjustments().getCompatibilityInfo();</div><div class="line">			mTranslator = compatibilityInfo.getTranslator();</div><div class="line">			//&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x4E6;&#xFFFD;&#xFFFD;&#xFB;&#xFFFD;&#xFFFD;&#x4F5;&#xFFFD;&#xFFFD;&#xFFFD;&#x53C;&#xFFFD;&#xFFFD;&#xFFFD;surface&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xF4;&#xFFFD;&#xFFFD;&#x4AA;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x4F2;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">			// If the application owns the surface, don&apos;t enable hardware acceleration</div><div class="line">			if (mSurfaceHolder == null) {</div><div class="line">				enableHardwareAcceleration(attrs);</div><div class="line">			}</div><div class="line"></div><div class="line">			......</div><div class="line">			//&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x3AA;&#xFFFD;&#x47E;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">			mAdded = true;</div><div class="line">			int res; /* = WindowManagerImpl.ADD_OKAY; */</div><div class="line"></div><div class="line">			// Schedule the first layout -before- adding to the window</div><div class="line">			// manager, to make sure we do the relayout before receiving</div><div class="line">			// any other events from the system.</div><div class="line">			//&#xFFFD;&#xFFFD;&#x2BC;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;layout&#xFFFD;&#xFFFD;layout&#xFFFD;&#x139;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x368;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;Choreographer&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x435;&#xFFFD;&#xFFFD;&#xCCBD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">			requestLayout();</div><div class="line">			// &#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x368;&#xFFFD;&#xFFFD;&#xFFFD;&#x13D;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">			if ((mWindowAttributes.inputFeatures</div><div class="line">					&amp; WindowManager.LayoutParams.INPUT_FEATURE_NO_INPUT_CHANNEL) == 0) {</div><div class="line">				mInputChannel = new InputChannel();</div><div class="line">			}</div><div class="line">			mForceDecorViewVisibility = (mWindowAttributes.privateFlags</div><div class="line">					&amp; PRIVATE_FLAG_FORCE_DECOR_VIEW_VISIBILITY) != 0;</div><div class="line">			try {</div><div class="line">				mOrigWindowType = mWindowAttributes.type;</div><div class="line">				mAttachInfo.mRecomputeGlobalAttributes = true;</div><div class="line">				collectViewAttributes();</div><div class="line">				//&#x368;&#xFFFD;&#xFFFD;windowSession&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x2BE;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x4AA;&#xFFFD;&#x1F4;&#xFFFD;&#xFFFD;&#xFFFD;SurfaceSession&#xFFFD;&#xFFFD;SurfaceSession&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;surface flinger</div><div class="line">				//&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x368;&#xFFFD;&#xFFFD;native&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;SurfaceControl&#x2B1;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">				res = mWindowSession.addToDisplay(mWindow, mSeq, mWindowAttributes,</div><div class="line">						getHostVisibility(), mDisplay.getDisplayId(),</div><div class="line">						mAttachInfo.mContentInsets, mAttachInfo.mStableInsets,</div><div class="line">						mAttachInfo.mOutsets, mInputChannel);</div><div class="line">			} catch (RemoteException e) {</div><div class="line">				mAdded = false;</div><div class="line">				mView = null;</div><div class="line">				mAttachInfo.mRootView = null;</div><div class="line">				mInputChannel = null;</div><div class="line">				mFallbackEventHandler.setView(null);</div><div class="line">				unscheduleTraversals();</div><div class="line">				setAccessibilityFocus(null, null);</div><div class="line">				throw new RuntimeException(&quot;Adding window failed&quot;, e);</div><div class="line">			} finally {</div><div class="line">				if (restore) {</div><div class="line">					attrs.restore();</div><div class="line">				}</div><div class="line">			}</div><div class="line"></div><div class="line">			if (mTranslator != null) {</div><div class="line">				mTranslator.translateRectInScreenToAppWindow(mAttachInfo.mContentInsets);</div><div class="line">			}</div><div class="line">			mPendingOverscanInsets.set(0, 0, 0, 0);</div><div class="line">			mPendingContentInsets.set(mAttachInfo.mContentInsets);</div><div class="line">			mPendingStableInsets.set(mAttachInfo.mStableInsets);</div><div class="line">			mPendingVisibleInsets.set(0, 0, 0, 0);</div><div class="line">			mAttachInfo.mAlwaysConsumeNavBar =</div><div class="line">					(res &amp; WindowManagerGlobal.ADD_FLAG_ALWAYS_CONSUME_NAV_BAR) != 0;</div><div class="line">			mPendingAlwaysConsumeNavBar = mAttachInfo.mAlwaysConsumeNavBar;</div><div class="line">			if (DEBUG_LAYOUT) Log.v(mTag, &quot;Added window &quot; + mWindow);</div><div class="line">			// &#xFFFD;&#xFFFD;&#xFFFD;&#x635;&#x13D;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x1F3;&#x279;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x77D;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x5F3;&#xFFFD;&#xFFFD;&#xCCE3;</div><div class="line">			if (res &lt; WindowManagerGlobal.ADD_OKAY) {</div><div class="line">				mAttachInfo.mRootView = null;</div><div class="line">				mAdded = false;</div><div class="line">				mFallbackEventHandler.setView(null);</div><div class="line">				unscheduleTraversals();</div><div class="line">				setAccessibilityFocus(null, null);</div><div class="line">				switch (res) {</div><div class="line">					......</div><div class="line">				}</div><div class="line">				throw new RuntimeException(</div><div class="line">						&quot;Unable to add window -- unknown error code &quot; + res);</div><div class="line">			}</div><div class="line">			// &#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xBC;&#xFFFD;&#xFFFD;&#xFFFD;callback&#xFFFD;&#xFFFD;&#x4BB;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xB6;&#xFFFD;&#x3AA;null</div><div class="line">			if (view instanceof RootViewSurfaceTaker) {</div><div class="line">				mInputQueueCallback =</div><div class="line">					((RootViewSurfaceTaker)view).willYouTakeTheInputQueue();</div><div class="line">			}</div><div class="line">			// &#x5E2;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xBC;&#xFFFD;&#xFFFD;&#x13C;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">			if (mInputChannel != null) {</div><div class="line">				if (mInputQueueCallback != null) {</div><div class="line">					mInputQueue = new InputQueue();</div><div class="line">					mInputQueueCallback.onInputQueueCreated(mInputQueue);</div><div class="line">				}</div><div class="line">				mInputEventReceiver = new WindowInputEventReceiver(mInputChannel,</div><div class="line">						Looper.myLooper());</div><div class="line">			}</div><div class="line">			//&#xFFFD;&#xF5;&#xFFFD;&#x1F0;&#xFFFD;&#xFFFD;ViewRootImpl&#xFFFD;&#xFFFD;&#x3AA;view&#xFFFD;&#x138;&#xFFFD;&#xFFFD;&#x5E1;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">			view.assignParent(this);</div><div class="line">			mAddedTouchMode = (res &amp; WindowManagerGlobal.ADD_FLAG_IN_TOUCH_MODE) != 0;</div><div class="line">			mAppVisible = (res &amp; WindowManagerGlobal.ADD_FLAG_APP_VISIBLE) != 0;</div><div class="line"></div><div class="line">			if (mAccessibilityManager.isEnabled()) {</div><div class="line">				mAccessibilityInteractionConnectionManager.ensureConnection();</div><div class="line">			}</div><div class="line"></div><div class="line">			if (view.getImportantForAccessibility() == View.IMPORTANT_FOR_ACCESSIBILITY_AUTO) {</div><div class="line">				view.setImportantForAccessibility(View.IMPORTANT_FOR_ACCESSIBILITY_YES);</div><div class="line">			}</div><div class="line"></div><div class="line">			// Set up the input pipeline.</div><div class="line">			......</div><div class="line">		}</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure></p>
</blockquote>
<hr>
<h1 id="4-Session&#xFFFD;&#xFFFD;addToDisplay"><a href="#4-Session&#xFFFD;&#xFFFD;addToDisplay" class="headerlink" title="4. Session&#xFFFD;&#xFFFD;addToDisplay"></a>4. Session&#xFFFD;&#xFFFD;addToDisplay</h1><blockquote>
<p>Session&#xFFFD;&#xFFFD;addToDisplay&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;WMS&#xFFFD;&#xFFFD;addWindow&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;WMS&#xFFFD;&#x435;&#xFFFD;addWindow&#xFFFD;&#xFFFD;&#x4AA;&#xFFFD;&#x1F4;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x4BB;&#xFFFD;&#xFFFD;WindowState&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x368;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;<code>attach</code>&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;Session&#xFFFD;&#x435;&#xFFFD;<code>windowAddedLocked</code>&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;SurfaceSession&#xFFFD;&#xFFFD;&#x368;&#xFFFD;&#xFFFD;SurfaceSession&#xFFFD;&#xFFFD;&#xFFFD;&#x53A;&#xFFFD;surface flinger&#xFFFD;&#xFFFD;&#xFFFD;&#x4E1;&#xFFFD;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div></pre></td><td class="code"><pre><div class="line">Session.java:</div><div class="line">@Override</div><div class="line">public int addToDisplay(IWindow window, int seq, WindowManager.LayoutParams attrs,</div><div class="line">		int viewVisibility, int displayId, Rect outContentInsets, Rect outStableInsets,</div><div class="line">		Rect outOutsets, InputChannel outInputChannel) {</div><div class="line">	return mService.addWindow(this, window, seq, attrs, viewVisibility, displayId,</div><div class="line">			outContentInsets, outStableInsets, outOutsets, outInputChannel);</div><div class="line">}</div><div class="line"></div><div class="line">WMS:</div><div class="line">public int addWindow(Session session, IWindow client, int seq,</div><div class="line">		WindowManager.LayoutParams attrs, int viewVisibility, int displayId,</div><div class="line">		Rect outContentInsets, Rect outStableInsets, Rect outOutsets,</div><div class="line">		InputChannel outInputChannel) {</div><div class="line">	int[] appOp = new int[1];</div><div class="line">	//&#x228;&#xFFFD;&#x7BC;&#xFFFD;&#xFFFD;&#xFFFD;&#x2B5;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;WindowManagerPolicy</div><div class="line">	int res = mPolicy.checkAddPermission(attrs, appOp);</div><div class="line">	if (res != WindowManagerGlobal.ADD_OKAY) {</div><div class="line">		return res;</div><div class="line">	}</div><div class="line"></div><div class="line">	boolean reportNewConfig = false;</div><div class="line">	WindowState parentWindow = null;</div><div class="line">	long origId;</div><div class="line">	final int callingUid = Binder.getCallingUid();</div><div class="line">	final int type = attrs.type;</div><div class="line"></div><div class="line">	synchronized(mWindowMap) {</div><div class="line">		//&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">		......</div><div class="line">		</div><div class="line">		AppWindowToken atoken = null;</div><div class="line">		final boolean hasParent = parentWindow != null;</div><div class="line">		// Use existing parent window token for child windows since they go in the same token</div><div class="line">		// as there parent window so we can apply the same policy on them.</div><div class="line">		WindowToken token = displayContent.getWindowToken(</div><div class="line">				hasParent ? parentWindow.mAttrs.token : attrs.token);</div><div class="line">		// If this is a child window, we want to apply the same type checking rules as the</div><div class="line">		// parent window type.</div><div class="line">		final int rootType = hasParent ? parentWindow.mAttrs.type : type;</div><div class="line"></div><div class="line">		boolean addToastWindowRequiresToken = false;</div><div class="line"></div><div class="line">		if (token == null) {</div><div class="line">		//&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">			......</div><div class="line">			final IBinder binder = attrs.token != null ? attrs.token : client.asBinder();</div><div class="line">			token = new WindowToken(this, binder, type, false, displayContent,</div><div class="line">					session.mCanAddInternalSystemWindow);</div><div class="line">		} else if (rootType &gt;= FIRST_APPLICATION_WINDOW &amp;&amp; rootType &lt;= LAST_APPLICATION_WINDOW) {</div><div class="line">			atoken = token.asAppWindowToken();</div><div class="line">			......</div><div class="line">		} ......//&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">		} else if (token.asAppWindowToken() != null) {</div><div class="line">			attrs.token = null;</div><div class="line">			token = new WindowToken(this, client.asBinder(), type, false, displayContent,</div><div class="line">					session.mCanAddInternalSystemWindow);</div><div class="line">		}</div><div class="line">		</div><div class="line">		//&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;WindowState&#xFFFD;&#xFFFD;</div><div class="line">		final WindowState win = new WindowState(this, session, client, token, parentWindow,</div><div class="line">				appOp[0], seq, attrs, viewVisibility, session.mUid,</div><div class="line">				session.mCanAddInternalSystemWindow);</div><div class="line">		......</div><div class="line">		</div><div class="line">		//&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x368;&#xFFFD;&#xFFFD;</div><div class="line">		final boolean openInputChannels = (outInputChannel != null</div><div class="line">				&amp;&amp; (attrs.inputFeatures &amp; INPUT_FEATURE_NO_INPUT_CHANNEL) == 0);</div><div class="line">		if  (openInputChannels) {</div><div class="line">			win.openInputChannel(outInputChannel);</div><div class="line">		}</div><div class="line"></div><div class="line">		//&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;toast&#xFFFD;&#xFFFD;&#x4BB;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">		......</div><div class="line"></div><div class="line">		res = WindowManagerGlobal.ADD_OKAY;</div><div class="line">		if (mCurrentFocus == null) {</div><div class="line">			mWinAddedSinceNullFocus.add(win);</div><div class="line">		}</div><div class="line"></div><div class="line">		if (excludeWindowTypeFromTapOutTask(type)) {</div><div class="line">			displayContent.mTapExcludedWindows.add(win);</div><div class="line">		}</div><div class="line"></div><div class="line">		origId = Binder.clearCallingIdentity();</div><div class="line">		//&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;WindowState&#xFFFD;&#xFFFD;attach&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x43D;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">		win.attach();</div><div class="line">		//&#xFFFD;&#xFFFD;WindowState&#xFFFD;&#x374;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;IWindow&#xFFFD;&#xFFFD;&#xFFFD;&#x6D7D;mWindowMap&#xFFFD;&#xFFFD;</div><div class="line">		mWindowMap.put(client.asBinder(), win);</div><div class="line">		......</div><div class="line"></div><div class="line">	return res;</div><div class="line">}</div><div class="line"></div><div class="line">WindowState.java:</div><div class="line">void attach() {</div><div class="line">	if (localLOGV) Slog.v(TAG, &quot;Attaching &quot; + this + &quot; token=&quot; + mToken);</div><div class="line">	mSession.windowAddedLocked(mAttrs.packageName);</div><div class="line">}</div><div class="line"></div><div class="line">Session.java:</div><div class="line">void windowAddedLocked(String packageName) {</div><div class="line">	//&#xFFFD;&#xFFFD;&#xFFFD;&#xF0;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">	mPackageName = packageName;</div><div class="line">	mRelayoutTag = &quot;relayoutWindow: &quot; + mPackageName;</div><div class="line">	if (mSurfaceSession == null) {</div><div class="line">		//&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;SurfaceSession&#xFFFD;&#xFFFD;surface flinger&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">		mSurfaceSession = new SurfaceSession();</div><div class="line">		</div><div class="line">		mService.mSessions.add(this);</div><div class="line">		if (mLastReportedAnimatorScale != mService.getCurrentAnimatorScale()) {</div><div class="line">			mService.dispatchNewAnimatorScaleLocked(this);</div><div class="line">		}</div><div class="line">	}</div><div class="line">	mNumWindow++;</div><div class="line">}</div></pre></td></tr></table></figure></p>
<p>SurfaceSession&#xFFFD;&#xFFFD;&#x368;&#xFFFD;&#xFFFD;native&#xFFFD;&#x3D34;&#xFFFD;&#xFFFD;&#xFFFD;&#x123;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</p>
</blockquote>
<hr>
<h1 id="6-Choreographer&#xFFFD;&#xFFFD;TraversalRunnable&#xFFFD;&#xCCBD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x5B4;&#xFFFD;&#xFFFD;"><a href="#6-Choreographer&#xFFFD;&#xFFFD;TraversalRunnable&#xFFFD;&#xCCBD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x5B4;&#xFFFD;&#xFFFD;" class="headerlink" title="6. Choreographer&#xFFFD;&#xFFFD;TraversalRunnable&#xFFFD;&#xCCBD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x5B4;&#xFFFD;&#xFFFD;"></a>6. Choreographer&#xFFFD;&#xFFFD;TraversalRunnable&#xFFFD;&#xCCBD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x5B4;&#xFFFD;&#xFFFD;</h1><blockquote>
<p>ViewRootImpl&#xFFFD;&#x435;&#xFFFD;Choreographer&#x368;&#xFFFD;&#xFFFD;postCallback&#xFFFD;&#xFFFD;&#x2BD;&#x2B5;&#xFFFD;&#xFFFD;&#xFFFD;&#xCCBD;&#xFFFD;&#x131;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;Choreographer&#xFFFD;&#xFFFD;&#xFFFD;&#x6B5;&#x5F2;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;VSYNC&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x5B1;&#x36C;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x17A;&#x163;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x574;&#xFFFD;&#x5B1;&#x36C;&#xFFFD;&#xFFFD;&#xFFFD;&#x17A;&#x17A;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x436;&#x3FE;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x1F1;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;TraversalRunnable&#xFFFD;&#xFFFD;run&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;run&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x435;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;ViewRootImpl&#xFFFD;&#xFFFD;doTraversal&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;doTraversal&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;performTraversals()&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;performTraversals()&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x131;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x4BB;&#xFFFD;&#xB4;&#xFFFD;&#xFFFD;&#xB8E8;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x32B;&#xFFFD;&#xFFFD;&#xFFFD;&#x2E3;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x4AA;&#xFFFD;&#xFFFD;&#x3AA;&#xFFFD;&#x132;&#xFFFD;&#xFFFD;&#x5A3;&#xFFFD;</p>
<ol>
<li><code>relayoutWindow</code>&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x1D34;&#xFFFD;&#xFFFD;SurfaceControl&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x4BD;&#xFFFD;&#x5AE;&#x1F0;&#xFFFD;&#xFFFD;SurfaceSession&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xB863;</li>
<li>&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;<code>performMeasure</code>&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;View&#xFFFD;&#xFFFD;&#xFFFD;&#x432;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</li>
<li>&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;<code>performLayout</code>&#xFFFD;&#xFFFD;View&#xFFFD;&#x13D;&#xFFFD;&#xFFFD;&#x432;&#xFFFD;&#xFFFD;&#x5A1;&#xFFFD;</li>
<li>&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;<code>performDraw</code>&#xFFFD;&#xFFFD;&#xFFFD;&#x43B;&#xFFFD;&#xFFFD;&#x1A1;&#xFFFD;<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">final class TraversalRunnable implements Runnable {</div><div class="line">	@Override</div><div class="line">	public void run() {</div><div class="line">		doTraversal();</div><div class="line">	}</div><div class="line">}</div><div class="line"></div><div class="line">void doTraversal() {</div><div class="line">	......</div><div class="line">		performTraversals();</div><div class="line">	......</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line">private void performTraversals() {</div><div class="line">	// cache mView since it is used so much below...</div><div class="line">	final View host = mView;</div><div class="line">	......</div><div class="line">		try {</div><div class="line">			......</div><div class="line">			//&#xFFFD;&#xFFFD;&#xFFFD;&#xB2;&#xFFFD;&#xFFFD;&#xFFFD;window&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x4AA;&#xFFFD;&#xFFFD;surface&#xFFFD;&#x134;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">			relayoutResult = relayoutWindow(params, viewVisibility, insetsPending);</div><div class="line">			......</div><div class="line">		} </div><div class="line">		......</div><div class="line">		if (!mStopped || mReportNextDraw) {</div><div class="line">				......</div><div class="line"></div><div class="line">				 // Ask host how big it wants to be</div><div class="line">				 //&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">				performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</div><div class="line">				......</div><div class="line">		}</div><div class="line">		......</div><div class="line">	if (didLayout) {</div><div class="line">		//&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">		performLayout(lp, mWidth, mHeight);</div><div class="line">		......</div><div class="line">	}</div><div class="line">	......</div><div class="line">	if (!cancelDraw &amp;&amp; !newSurface) {</div><div class="line">		//&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">		performDraw();</div><div class="line">	} </div><div class="line">}</div></pre></td></tr></table></figure>
</li>
</ol>
</blockquote>
<hr>
<h2 id="6-1-relayoutWindow&#xFFFD;L&#xFFFD;&#xFFFD;&#xFFFD;"><a href="#6-1-relayoutWindow&#xFFFD;L&#xFFFD;&#xFFFD;&#xFFFD;" class="headerlink" title="6.1 relayoutWindow&#xFFFD;&#x139;&#xFFFD;&#xFFFD;&#xFFFD;"></a>6.1 relayoutWindow&#xFFFD;&#x139;&#xFFFD;&#xFFFD;&#xFFFD;</h2><blockquote>
<p>&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x139;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x1F1;&#x23D;&#x3F6;&#xFFFD;&#xFFFD;&#x123;&#xFFFD;&#xFFFD;&#x5B2;&#xFFFD;&#xFFFD;&#xFFFD;&#x2F5;&#xFFFD;&#xFFFD;</p>
<ol>
<li><p>&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;Session&#xFFFD;&#xFFFD;relayout</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">ViewRootImpl.java:</div><div class="line">private int relayoutWindow(WindowManager.LayoutParams params, int viewVisibility,</div><div class="line">		boolean insetsPending) throws RemoteException {</div><div class="line">	......</div><div class="line">	//&#xFFFD;&#xFFFD;&#xFFFD;&#xFEF9;&#xFFFD;&#xFFFD;&#x368;&#xFFFD;&#xFFFD;Session&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;relayout&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x532;&#xFFFD;&#xFFFD;&#xFFFD;Session&#xFFFD;&#x43B;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;WMS&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;relayout</div><div class="line">	//&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x2F5;&#xFFFD;&#xB2;&#xFFFD;&#xFFFD;&#xFFFD;mSurface&#xFFFD;&#xFFFD;Surface&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;java&#xFFFD;&#xFFFD;&#x5B1;&#xFFFD;&#xFFFD;new&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x4BB;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xE3B32;&#xFFFD;&#xFB;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">	//&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x368;&#xFFFD;&#xFFFD;new SurfaceControl&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;Surface&#xFFFD;&#xFFFD;&#x368;&#xFFFD;&#xFFFD;surfaceController.getSurface(outSurface)&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;Surface</div><div class="line">	int relayoutResult = mWindowSession.relayout(</div><div class="line">			mWindow, mSeq, params,</div><div class="line">			(int) (mView.getMeasuredWidth() * appScale + 0.5f),</div><div class="line">			(int) (mView.getMeasuredHeight() * appScale + 0.5f),</div><div class="line">			viewVisibility, insetsPending ? WindowManagerGlobal.RELAYOUT_INSETS_PENDING : 0,</div><div class="line">			mWinFrame, mPendingOverscanInsets, mPendingContentInsets, mPendingVisibleInsets,</div><div class="line">			mPendingStableInsets, mPendingOutsets, mPendingBackDropFrame, mPendingConfiguration,</div><div class="line">			mSurface);</div><div class="line"></div><div class="line">	......</div><div class="line">	return relayoutResult;</div><div class="line">}</div></pre></td></tr></table></figure>
</li>
<li><p>Sessoin&#xFFFD;&#x435;&#xFFFD;relayout&#xFFFD;&#xFFFD;&#x225;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;WMS&#xFFFD;&#x435;&#xFFFD;relayoutWindow&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFF;&#xFFFD;&#x3B6;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xB7;&#xFFFD;&#xFFFD;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">Session.java:</div><div class="line">public int relayout(IWindow window, int seq, WindowManager.LayoutParams attrs,</div><div class="line">		int requestedWidth, int requestedHeight, int viewFlags,</div><div class="line">		int flags, Rect outFrame, Rect outOverscanInsets, Rect outContentInsets,</div><div class="line">		Rect outVisibleInsets, Rect outStableInsets, Rect outsets, Rect outBackdropFrame,</div><div class="line">		MergedConfiguration mergedConfiguration, Surface outSurface) {</div><div class="line">	//&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x23B;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;WMS&#xFFFD;&#xFFFD;relayoutWindow&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">	int res = mService.relayoutWindow(this, window, seq, attrs,</div><div class="line">			requestedWidth, requestedHeight, viewFlags, flags,</div><div class="line">			outFrame, outOverscanInsets, outContentInsets, outVisibleInsets,</div><div class="line">			outStableInsets, outsets, outBackdropFrame, mergedConfiguration, outSurface);</div><div class="line"></div><div class="line">	return res;</div><div class="line">}</div></pre></td></tr></table></figure>
</li>
<li><p>WMS&#xFFFD;&#xFFFD;relayoutWindow&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x368;&#xFFFD;&#xFFFD;createSurfaceControl&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;SurfaceControl&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x368;&#xFFFD;&#xFFFD;WindowSurfaceController.getSurface&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x132;&#xFFFD;&#xFFFD;&#xFFFD;Surface&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x5B5;&#xFFFD;&#xFFFD;copyFrom&#xFFFD;&#xFFFD;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">WMS:</div><div class="line">public int relayoutWindow(Session session, IWindow client, int seq,</div><div class="line">		WindowManager.LayoutParams attrs, int requestedWidth,</div><div class="line">		int requestedHeight, int viewVisibility, int flags,</div><div class="line">		Rect outFrame, Rect outOverscanInsets, Rect outContentInsets,</div><div class="line">		Rect outVisibleInsets, Rect outStableInsets, Rect outOutsets, Rect outBackdropFrame,</div><div class="line">		MergedConfiguration mergedConfiguration, Surface outSurface) {</div><div class="line">			......</div><div class="line">			result = win.relayoutVisibleWindow(mergedConfiguration, result, attrChanges,</div><div class="line">					oldVisibility);</div><div class="line">			try {</div><div class="line">				// &#xFFFD;&#xFFFD;&#xFFFD;&#xFD34;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;SurfaceControl</div><div class="line">				result = createSurfaceControl(outSurface, result, win, winAnimator);</div><div class="line">			} catch (Exception e) {</div><div class="line">				mInputMonitor.updateInputWindowsLw(true /*force*/);</div><div class="line"></div><div class="line">				Slog.w(TAG_WM, &quot;Exception thrown when creating surface for client &quot;</div><div class="line">						 + client + &quot; (&quot; + win.mAttrs.getTitle() + &quot;)&quot;,</div><div class="line">						 e);</div><div class="line">				Binder.restoreCallingIdentity(origId);</div><div class="line">				return 0;</div><div class="line">			}</div><div class="line">			......</div><div class="line">		</div><div class="line">	Binder.restoreCallingIdentity(origId);</div><div class="line">	return result;</div><div class="line">}</div><div class="line"></div><div class="line">WindowStateAnimator.java:</div><div class="line">WindowSurfaceController createSurfaceLocked(int windowType, int ownerUid) {</div><div class="line">	......</div><div class="line">	try {</div><div class="line">		// &#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;WindowSurfaceController&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x53F;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x132;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;Session&#xFFFD;&#x435;&#xFFFD;SurfaceSession&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">		// &#x5AE;&#x1F0;&#x4B2;&#x2F5;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;SurfaceSession&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;Surface flingler&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x4BE;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;Surface&#xFFFD;&#xFFFD;Surface flinger&#xFFFD;&#xFFFD;&#x368;&#xFFFD;&#xFFFD;SurfaceSession&#xFFFD;&#xFFFD;&#xFFFD;&#x4E1;&#xFFFD;</div><div class="line">		mSurfaceController = new WindowSurfaceController(mSession.mSurfaceSession,</div><div class="line">				attrs.getTitle().toString(),</div><div class="line">				width, height, format, flags, this, windowType, ownerUid);</div><div class="line">		......</div><div class="line">	} catch (OutOfResourcesException e) {</div><div class="line">		Slog.w(TAG, &quot;OutOfResourcesException creating surface&quot;);</div><div class="line">		mService.mRoot.reclaimSomeSurfaceMemory(this, &quot;create&quot;, true);</div><div class="line">		mDrawState = NO_SURFACE;</div><div class="line">		return null;</div><div class="line">	} catch (Exception e) {</div><div class="line">		Slog.e(TAG, &quot;Exception creating surface&quot;, e);</div><div class="line">		mDrawState = NO_SURFACE;</div><div class="line">		return null;</div><div class="line">	}</div><div class="line">	......</div><div class="line">	return mSurfaceController;</div><div class="line">}</div></pre></td></tr></table></figure>
</li>
<li><p>createSurfaceControl&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x368;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;WindowStateAnimator&#xFFFD;&#xFFFD;createSurfaceLocked&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x225;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;WindowSurfaceController</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">WMS:</div><div class="line">private int createSurfaceControl(Surface outSurface, int result, WindowState win,</div><div class="line">		WindowStateAnimator winAnimator) {</div><div class="line">	......</div><div class="line">	try {</div><div class="line">		// &#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;createSurfaceLocked</div><div class="line">		surfaceController = winAnimator.createSurfaceLocked(win.mAttrs.type, win.mOwnerUid);</div><div class="line">	} </div><div class="line">	......</div><div class="line">	if (surfaceController != null) {</div><div class="line">		// &#x368;&#xFFFD;&#xFFFD;Surface.copyFrom&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;Surface</div><div class="line">		surfaceController.getSurface(outSurface);</div><div class="line">		</div><div class="line">	} else {</div><div class="line">		......</div><div class="line">		outSurface.release();</div><div class="line">	}</div><div class="line">	return result;</div><div class="line">}</div></pre></td></tr></table></figure>
</li>
<li><p>WindowSurfaceController&#xFFFD;&#x134;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x368;&#xFFFD;&#xFFFD;&#xFFFD;&#x436;&#x3F5;&#xFFFD;&#x1F0;&#xFFFD;&#x1F7;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;debug&#x5F4;&#x32C;&#xFFFD;&#xFFFD;&#xFFFD;&#x436;&#x3F4;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;SurfaceControl</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">WindowSurfaceController.java:</div><div class="line">public WindowSurfaceController(SurfaceSession s, String name, int w, int h, int format,</div><div class="line">		int flags, WindowStateAnimator animator, int windowType, int ownerUid) {</div><div class="line">	</div><div class="line">	......</div><div class="line">		//&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;SurfaceControl&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x5BF;&#xFFFD;&#xFFFD;&#x53F;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x1FF;&#xFFFD;&#xFFFD;&#xFFFD;Surface&#xFFFD;&#xFFFD;&#xFFFD;&#x8EC;&#xFFFD;&#xFFFD;&#x23B;&#xFFFD;&#x2F2;&#xFFFD;&#xFFFD;&#xFFFD;&#x4B2;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x5AE;&#x1F0;&#xFFFD;&#xFFFD;SurfaceSession&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">		mSurfaceControl = new SurfaceControl(</div><div class="line">				s, name, w, h, format, flags, windowType, ownerUid);</div><div class="line">	......</div><div class="line">}</div></pre></td></tr></table></figure>
</li>
<li><p>SurfaceControl&#xFFFD;&#x13E;&#xFFFD;&#xFFFD;&#x5D34;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x368;&#xFFFD;&#xFFFD;nativeCreate&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x23B;&#xFFFD;&#x2F2;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x5AE;&#x1F0;&#xFFFD;&#xFFFD;SurfaceSession&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x5AE;&#x1F0;&#x4B2;&#x2F5;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;SurfaceSession&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;Surface flingler&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x4BE;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;Surface&#xFFFD;&#xFFFD;Surface flinger&#xFFFD;&#xFFFD;&#x368;&#xFFFD;&#xFFFD;SurfaceSession&#xFFFD;&#xFFFD;&#xFFFD;&#x4E1;&#xFFFD;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">SurfaceControl.java:</div><div class="line">public SurfaceControl(SurfaceSession session,</div><div class="line">		String name, int w, int h, int format, int flags)</div><div class="line">				throws OutOfResourcesException {</div><div class="line">	if (session == null) {</div><div class="line">		throw new IllegalArgumentException(&quot;session must not be null&quot;);</div><div class="line">	}</div><div class="line">	if (name == null) {</div><div class="line">		throw new IllegalArgumentException(&quot;name must not be null&quot;);</div><div class="line">	}</div><div class="line"></div><div class="line">	mName = name;</div><div class="line">	// &#x368;&#xFFFD;&#xFFFD;native&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD; SurfaceSession &#xFFFD;&#xFFFD; &#xFFFD;&#x7F5;&#xFFFD;</div><div class="line">	// &#xFFFD;&#xFFFD;&#xFFFD;&#x5D34;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x1F2;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">	mNativeObject = nativeCreate(session, name, w, h, format, flags);</div><div class="line">	if (mNativeObject == 0) {</div><div class="line">		throw new OutOfResourcesException(</div><div class="line">				&quot;Couldn&apos;t allocate SurfaceControl native object&quot;);</div><div class="line">	}</div><div class="line"></div><div class="line">	mCloseGuard.open(&quot;release&quot;);</div><div class="line">}</div></pre></td></tr></table></figure>
</li>
</ol>
<p>&#x5B4;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;relayoutWindow&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x1F5;&#xFFFD;<code>mSurface</code>&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x4BB;&#xFFFD;&#xFFFD;&#xFFFD;&#x576;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x136;&#xFFFD;&#xFFFD;&#xE3B36;&#xFFFD;&#xFFFD;&#xFFFD;&#x4BB;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x201D;&#xFFFD;&#xFFFD;Surface&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</p>
</blockquote>
<hr>
<h2 id="6-2-performMeasure&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;"><a href="#6-2-performMeasure&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;" class="headerlink" title="6.2 performMeasure&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;"></a>6.2 performMeasure&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</h2><blockquote>
<p>performMeasure&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x5B4;&#xFFFD;&#x43A;&#x73C;&#xB5963;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x1F5;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;View&#xFFFD;&#xFFFD;measure&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">private void performMeasure(int childWidthMeasureSpec, int childHeightMeasureSpec) {</div><div class="line">	Trace.traceBegin(Trace.TRACE_TAG_VIEW, &quot;measure&quot;);</div><div class="line">	try {</div><div class="line">		//&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;View&#xFFFD;&#xFFFD;measure&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x1F3;&#xFFFD;&#xFFFD;&#x37F;&#xFFFD;&#xFFFD;&#x132;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">		mView.measure(childWidthMeasureSpec, childHeightMeasureSpec);</div><div class="line">	} finally {</div><div class="line">		Trace.traceEnd(Trace.TRACE_TAG_VIEW);</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure></p>
<p>&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;View&#xFFFD;&#xFFFD;measure&#xFFFD;&#xFFFD;&#xFFFD;&#xFCBB;&#xFFFD;&#xFFFD;&#x2F5;&#xFFFD;&#xFFFD;</p>
</blockquote>
<hr>
<h2 id="6-3-performLayout&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;"><a href="#6-3-performLayout&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;" class="headerlink" title="6.3 performLayout&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;"></a>6.3 performLayout&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</h2><blockquote>
<p>performLayout&#xFFFD;&#xFFFD;&#x4AA;&#xFFFD;&#x1F5;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;View&#xFFFD;&#xFFFD;layout&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;DecorView&#xFFFD;&#xFFFD;FrameLayout&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x8EC;FrameLayout&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;ViewGroup&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x8EC;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;ViewGroup&#xFFFD;&#xFFFD;layout&#xFFFD;&#xFFFD;final&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xF5;&#xFFFD;&#xFFFD;&#xFFFD;ViewGroup&#xFFFD;&#xFFFD;layout&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x13B;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;View&#xFFFD;&#xFFFD;layout&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line">private void performLayout(WindowManager.LayoutParams lp, int desiredWindowWidth,</div><div class="line">		int desiredWindowHeight) {</div><div class="line">	mLayoutRequested = false;</div><div class="line">	mScrollMayChange = true;</div><div class="line">	// &#xFFFD;&#x6B2;&#xFFFD;&#xFFFD;&#x5B9;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">	mInLayout = true;</div><div class="line"></div><div class="line">	final View host = mView;</div><div class="line">	if (DEBUG_ORIENTATION || DEBUG_LAYOUT) {</div><div class="line">		Log.v(mTag, &quot;Laying out &quot; + host + &quot; to (&quot; +</div><div class="line">				host.getMeasuredWidth() + &quot;, &quot; + host.getMeasuredHeight() + &quot;)&quot;);</div><div class="line">	}</div><div class="line"></div><div class="line">	Trace.traceBegin(Trace.TRACE_TAG_VIEW, &quot;layout&quot;);</div><div class="line">	try {</div><div class="line">		// &#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;View&#xFFFD;&#xFFFD;decorView&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;layout&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">		host.layout(0, 0, host.getMeasuredWidth(), host.getMeasuredHeight());</div><div class="line">		// &#xFFFD;&#xFFFD;&#xFFFD;&#x6B2;&#xFFFD;&#xFFFD;&#x5B9;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">		mInLayout = false;</div><div class="line">		int numViewsRequestingLayout = mLayoutRequesters.size();</div><div class="line">		if (numViewsRequestingLayout &gt; 0) {</div><div class="line">			// &#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x5E2;&#xFFFD;&#x37A;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x2E3;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x6B2;&#xFFFD;&#xFFFD;&#x5B5;&#x139;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x4AA;&#xFFFD;&#xFFFD;requestLayout()&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x2E1;&#xFFFD;</div><div class="line">			// requestLayout() &#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;ViewRootImpl&#xFFFD;&#xFFFD;requestLayoutDuringLayout&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x53C;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x4F5;&#xFFFD;list&#xFFFD;&#xFFFD;</div><div class="line">			// &#xFFFD;&#xFFFD;&#x2B1;&#xFFFD;&#xFFFD;numViewsRequestingLayout &gt; 0&#x5B4;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x132;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">			// requestLayout() was called during layout.</div><div class="line">			// If no layout-request flags are set on the requesting views, there is no problem.</div><div class="line">			// If some requests are still pending, then we need to clear those flags and do</div><div class="line">			// a full request/measure/layout pass to handle this situation.</div><div class="line">			ArrayList&lt;View&gt; validLayoutRequesters = getValidLayoutRequesters(mLayoutRequesters,</div><div class="line">					false);</div><div class="line">			if (validLayoutRequesters != null) {</div><div class="line">				// Set this flag to indicate that any further requests are happening during</div><div class="line">				// the second pass, which may result in posting those requests to the next</div><div class="line">				// frame instead</div><div class="line">				mHandlingLayoutInLayoutRequest = true;</div><div class="line"></div><div class="line">				// Process fresh layout requests, then measure and layout</div><div class="line">				int numValidRequests = validLayoutRequesters.size();</div><div class="line">				for (int i = 0; i &lt; numValidRequests; ++i) {</div><div class="line">					final View view = validLayoutRequesters.get(i);</div><div class="line">					Log.w(&quot;View&quot;, &quot;requestLayout() improperly called by &quot; + view +</div><div class="line">							&quot; during layout: running second layout pass&quot;);</div><div class="line">					view.requestLayout();</div><div class="line">				}</div><div class="line">				measureHierarchy(host, lp, mView.getContext().getResources(),</div><div class="line">						desiredWindowWidth, desiredWindowHeight);</div><div class="line">				mInLayout = true;</div><div class="line">				host.layout(0, 0, host.getMeasuredWidth(), host.getMeasuredHeight());</div><div class="line"></div><div class="line">				mHandlingLayoutInLayoutRequest = false;</div><div class="line"></div><div class="line">				// Check the valid requests again, this time without checking/clearing the</div><div class="line">				// layout flags, since requests happening during the second pass get noop&apos;d</div><div class="line">				validLayoutRequesters = getValidLayoutRequesters(mLayoutRequesters, true);</div><div class="line">				if (validLayoutRequesters != null) {</div><div class="line">					final ArrayList&lt;View&gt; finalRequesters = validLayoutRequesters;</div><div class="line">					// Post second-pass requests to the next frame</div><div class="line">					getRunQueue().post(new Runnable() {</div><div class="line">						@Override</div><div class="line">						public void run() {</div><div class="line">							int numValidRequests = finalRequesters.size();</div><div class="line">							for (int i = 0; i &lt; numValidRequests; ++i) {</div><div class="line">								final View view = finalRequesters.get(i);</div><div class="line">								Log.w(&quot;View&quot;, &quot;requestLayout() improperly called by &quot; + view +</div><div class="line">										&quot; during second layout pass: posting in next frame&quot;);</div><div class="line">								view.requestLayout();</div><div class="line">							}</div><div class="line">						}</div><div class="line">					});</div><div class="line">				}</div><div class="line">			}</div><div class="line"></div><div class="line">		}</div><div class="line">	} finally {</div><div class="line">		Trace.traceEnd(Trace.TRACE_TAG_VIEW);</div><div class="line">	}</div><div class="line">	mInLayout = false;</div><div class="line">}</div></pre></td></tr></table></figure></p>
</blockquote>
<hr>
<h2 id="6-4-performDraw&#xFFFD;L&#xFFFD;&#xFFFD;&#xFFFD;"><a href="#6-4-performDraw&#xFFFD;L&#xFFFD;&#xFFFD;&#xFFFD;" class="headerlink" title="6.4 performDraw&#xFFFD;&#x139;&#xFFFD;&#xFFFD;&#xFFFD;"></a>6.4 performDraw&#xFFFD;&#x139;&#xFFFD;&#xFFFD;&#xFFFD;</h2><blockquote>
<p>&#x1F0;&#xFFFD;&#xFFFD;&#x2F5;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xF4;&#xFFFD;&#x8EC;&#x4B2;&#xFB;&#xFFFD;&#x5B5;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x1B5;&#x139;&#xFFFD;&#xFFFD;&#x321;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x263;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x263;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x13B;&#xFFFD;&#xFFFD;&#x1B5;&#x139;&#xFFFD;&#xFFFD;&#x321;&#xFFFD;&#xFFFD;&#xFFFD;performDraw&#xFFFD;&#xFFFD;<br>&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x1B9;&#xFFFD;&#xFFFD;&#x337;&#xFFFD;&#x3AA;&#xFFFD;&#xFFFD;&#xFFFD;&#x432;&#xFFFD;&#x36C;&#xFFFD;&#x13B;&#xFFFD;&#xFFFD;&#x1B9;&#xFFFD;&#xFFFD;&#x323;&#xFFFD;&#xFFFD;&#x4BF;&#xFFFD;&#xFFFD;&#x2FA;&#x736;&#xCA9;&#xFFFD;&#x363;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x3F7;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x136;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x1A1;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x1E3;&#xFFFD;Android 4.0&#xFFFD;&#xFFFD;&#xFFFD;&#x47E;&#xFFFD;<strong>&#x12C;&#xFFFD;&#x3FF;&#xFFFD;&#xFFFD;&#xFFFD;&#x4F2;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</strong>&#xFFFD;&#x2E3;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x635;&#xFFFD;&#x2F5;&#xFFFD;&#xFFFD;&#x4F2;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x1A3;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x6F30;native&#xFFFD;&#x38E9;&#xFFFD;&#xFFFD;<br>&#x4F2;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x675;&#xFFFD;&#xFFFD;&#xFFFD;&#x23E;&#xFFFD;&#xFFFD;&#xFFFD;&#x323;&#xFFFD;</p>
<ol>
<li><p>&#xFFFD;&#xFFFD;ViewRootImpl&#xFFFD;&#xFFFD;draw&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x423;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x4F2;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x67B;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;ThreadedRenderer&#xFFFD;&#xFFFD;draw&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x225;&#xFFFD;&#xFFFD;&#xFFFD;&#x1A1;&#xFFFD;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">ViewRootImpl.java:</div><div class="line">private void performDraw() {</div><div class="line">	......</div><div class="line">	try {</div><div class="line">		draw(fullRedrawNeeded);</div><div class="line">	} finally {</div><div class="line">		mIsDrawing = false;</div><div class="line">		Trace.traceEnd(Trace.TRACE_TAG_VIEW);</div><div class="line">	}</div><div class="line">	......</div><div class="line">		try {</div><div class="line">			mWindowSession.finishDrawing(mWindow);</div><div class="line">		} catch (RemoteException e) {</div><div class="line">		}</div><div class="line">}</div><div class="line"></div><div class="line">private void draw(boolean fullRedrawNeeded) {</div><div class="line">	</div><div class="line">	// &#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x53A;&#x37D;&#x4FF;&#x6BB;&#x635;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">	......</div><div class="line">	</div><div class="line">	mAttachInfo.mDrawingTime =</div><div class="line">			mChoreographer.getFrameTimeNanos() / TimeUtils.NANOS_PER_MS;</div><div class="line">	</div><div class="line">	if (!dirty.isEmpty() || mIsAnimating || accessibilityFocusDirty) {</div><div class="line">		// &#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x4F2;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x663;&#xFFFD;&#x5AE;&#x1F0;&#x2F5;&#xFFFD;&#xFFFD; &#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFB;&#xFFFD;&#xFFFD;&#xFFFD;&#x53C;&#xFFFD;&#xFFFD;&#xFFFD;SurfaceView&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x4F2;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x663;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x57B;&#xFFFD;&#x5B4;&#xFFFD;&#xFFFD;&#xFFFD;&#x2CBF;&#xFFFD;&#x5B4;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">		if (mAttachInfo.mHardwareRenderer != null &amp;&amp; mAttachInfo.mHardwareRenderer.isEnabled()) {</div><div class="line">			......</div><div class="line">			// ThreadedRenderer&#xFFFD;&#xFFFD;draw&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">			mAttachInfo.mHardwareRenderer.draw(mView, mAttachInfo, this);</div><div class="line">		} else {</div><div class="line">			......</div><div class="line">			// &#xFB;&#xFFFD;&#x43F;&#xFFFD;&#xFFFD;&#xFFFD;&#x4F2;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x663;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">			if (!drawSoftware(surface, mAttachInfo, xOffset, yOffset, scalingRequired, dirty)) {</div><div class="line">				return;</div><div class="line">			}</div><div class="line">		}</div><div class="line">	}</div><div class="line">	......</div><div class="line">}</div></pre></td></tr></table></figure>
</li>
<li><p>ThreadedRenderer&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;updateRootDisplayList&#xFFFD;&#xFFFD;&#xFFFD;&#xB8;&#xFFFD;&#xFFFD;&#xFFFD;&#x2BE;&#xFFFD;&#x431;&#xFFFD;&#xFFFD;&#xFFFD;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">ThreadedRenderer.java:</div><div class="line">void draw(View view, AttachInfo attachInfo, HardwareDrawCallbacks callbacks) {</div><div class="line">	attachInfo.mIgnoreDirtyState = true;</div><div class="line"></div><div class="line">	final Choreographer choreographer = attachInfo.mViewRootImpl.mChoreographer;</div><div class="line">	choreographer.mFrameInfo.markDrawStart();</div><div class="line">	// &#xFFFD;&#xFFFD;&#xFFFD;&#xB8;&#xFFFD;&#xFFFD;&#xFFFD;&#x2BE;&#xFFFD;&#x431;&#xFFFD;</div><div class="line">	updateRootDisplayList(view, callbacks);</div><div class="line"></div><div class="line">	......</div><div class="line">}</div></pre></td></tr></table></figure>
</li>
<li><p>updateRootDisplayList&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;View.updateDisplayListIfDirty&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;RenderNode&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x368;&#xFFFD;&#xFFFD;DisplayListCanvas.drawRenderNode&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x1A1;&#xFFFD;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">ThreadedRenderer.java:</div><div class="line">private void updateRootDisplayList(View view, HardwareDrawCallbacks callbacks) {</div><div class="line">	updateViewTreeDisplayList(view);</div><div class="line"></div><div class="line">	if (mRootNodeNeedsUpdate || !mRootNode.isValid()) {</div><div class="line">		DisplayListCanvas canvas = mRootNode.start(mSurfaceWidth, mSurfaceHeight);</div><div class="line">		try {</div><div class="line">			final int saveCount = canvas.save();</div><div class="line">			canvas.translate(mInsetLeft, mInsetTop);</div><div class="line">			callbacks.onHardwarePreDraw(canvas);</div><div class="line"></div><div class="line">			canvas.insertReorderBarrier();</div><div class="line">			// view.updateDisplayListIfDirty()&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x635;&#x38EC;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x13D;&#xFFFD;&#x4AA;&#xFFFD;&#xFFFD;&#x2BE;&#xFFFD;&#xFFFD;&#xFFFD;&#x431;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;canvas&#x225;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">			canvas.drawRenderNode(view.updateDisplayListIfDirty());</div><div class="line">			canvas.insertInorderBarrier();</div><div class="line"></div><div class="line">			callbacks.onHardwarePostDraw(canvas);</div><div class="line">			canvas.restoreToCount(saveCount);</div><div class="line">			mRootNodeNeedsUpdate = false;</div><div class="line">		} finally {</div><div class="line">			mRootNode.end(canvas);</div><div class="line">		}</div><div class="line">	}</div><div class="line">	Trace.traceEnd(Trace.TRACE_TAG_VIEW);</div><div class="line">}</div></pre></td></tr></table></figure>
</li>
<li><p>&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;View.updateDisplayListIfDirty()&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x4B5;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;canvas&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x368;&#xFFFD;&#xFFFD;draw&#xFFFD;&#xFFFD;dispatchDraw&#xFFFD;&#xFFFD;&#x4AA;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x4F5;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x3E3;&#xFFFD;&#x368;&#xFFFD;&#xFFFD;renderNode.end(canvas)&#xFFFD;&#xFFFD;&#xFFFD;&#xF5;&#xFFFD;&#x1F0;&#xFFFD;&#x13B;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x763;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x57D;&#xFFFD;&#xFFFD;&#xFFFD;GPU&#x373;&#x4BB;&#x225;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">View.java:</div><div class="line">public RenderNode updateDisplayListIfDirty() {</div><div class="line">	......</div><div class="line"></div><div class="line">		try {</div><div class="line">			if (layerType == LAYER_TYPE_SOFTWARE) {// &#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">				buildDrawingCache(true);</div><div class="line">				Bitmap cache = getDrawingCache(true);</div><div class="line">				if (cache != null) {</div><div class="line">					canvas.drawBitmap(cache, 0, 0, mLayerPaint);</div><div class="line">				}</div><div class="line">			} else {</div><div class="line">				computeScroll();</div><div class="line"></div><div class="line">				canvas.translate(-mScrollX, -mScrollY);</div><div class="line">				mPrivateFlags |= PFLAG_DRAWN | PFLAG_DRAWING_CACHE_VALID;</div><div class="line">				mPrivateFlags &amp;= ~PFLAG_DIRTY_MASK;</div><div class="line">				// &#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFB;&#xFFFD;&#x431;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x5B1;&#xFFFD;&#x4F5;&#xFFFD;&#xFFFD;&#xFFFD;dispatchDraw(canvas)&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;draw(canvas)</div><div class="line">				// Fast path for layouts with no backgrounds</div><div class="line">				if ((mPrivateFlags &amp; PFLAG_SKIP_DRAW) == PFLAG_SKIP_DRAW) {</div><div class="line">					dispatchDraw(canvas);</div><div class="line">					if (mOverlay != null &amp;&amp; !mOverlay.isEmpty()) {</div><div class="line">						mOverlay.getOverlayView().draw(canvas);</div><div class="line">					}</div><div class="line">				} else {</div><div class="line">					draw(canvas);</div><div class="line">				}</div><div class="line">			}</div><div class="line">		} finally {</div><div class="line">			// &#xFFFD;&#xFFFD;&#xFFFD;&#x1BD;&#x6B5;&#x3C63;&#xFFFD;&#x68EC;&#xFFFD;&#x4B5;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;canvas&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x368;&#xFFFD;&#xFFFD;draw&#xFFFD;&#xFFFD;dispatchDraw&#xFFFD;&#xFFFD;&#x4AA;&#xFFFD;&#xFFFD;&#xFFFD;&#x136;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x4F5;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x3E3;&#xFFFD;</div><div class="line">			// &#x368;&#xFFFD;&#xFFFD;renderNode.end(canvas)&#xFFFD;&#xFFFD;&#xFFFD;&#x6EED;&#xFFFD;&#xFFFD;&#x5F4;&#x32C;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x57D;&#xFFFD;&#xFFFD;&#xFFFD;GPU&#x225;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">			renderNode.end(canvas);</div><div class="line">			// &#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;alpha&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;</div><div class="line">			setDisplayListProperties(renderNode);</div><div class="line">		}</div><div class="line">	} else {</div><div class="line">		mPrivateFlags |= PFLAG_DRAWN | PFLAG_DRAWING_CACHE_VALID;</div><div class="line">		mPrivateFlags &amp;= ~PFLAG_DIRTY_MASK;</div><div class="line">	}</div><div class="line">	return renderNode;</div><div class="line">}</div></pre></td></tr></table></figure>
</li>
</ol>
<p>&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x1B9;&#xFFFD;&#xFFFD;&#x323;&#xFFFD;<br>drawSoftware&#x5B1;&#xFFFD;&#x4F5;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;View&#xFFFD;&#xFFFD;draw&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x368;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x5B1;&#xFFFD;&#x4FB;&#xFFFD;&#xFFFD;&#x1A1;&#xFFFD;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">private boolean drawSoftware(Surface surface, AttachInfo attachInfo, int xoff, int yoff,</div><div class="line">		boolean scalingRequired, Rect dirty) {</div><div class="line"></div><div class="line"></div><div class="line">	try {</div><div class="line">	......</div><div class="line">		try {</div><div class="line">			......</div><div class="line">			// &#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x1A3;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x4F2;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x23E;&#xFFFD;&#x531;&#x23F;&#xFFFD;&#xFFFD;&#x53F;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x5BB;&#xFFFD;&#xFFFD;canvas&#x225;draw&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x761;&#xFFFD;</div><div class="line">			mView.draw(canvas);</div><div class="line">			drawAccessibilityFocusedDrawableIfNeeded(canvas);</div><div class="line">		} finally {</div><div class="line">			if (!attachInfo.mSetIgnoreDirtyState) {</div><div class="line">				// Only clear the flag if it was not set during the mView.draw() call</div><div class="line">				attachInfo.mIgnoreDirtyState = false;</div><div class="line">			}</div><div class="line">		}</div><div class="line">	} finally {</div><div class="line">		......</div><div class="line">	}</div><div class="line">	return true;</div><div class="line">}</div></pre></td></tr></table></figure></p>
</blockquote>
<hr>
<h1 id="7-&#x434;&#xFFFD;&#x6BA;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;L&#xFFFD;"><a href="#7-&#x434;&#xFFFD;&#x6BA;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;L&#xFFFD;" class="headerlink" title="7. &#x434;&#xFFFD;&#x6BA;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x13B;&#xFFFD;"></a>7. &#x434;&#xFFFD;&#x6BA;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x13B;&#xFFFD;</h1><blockquote>
<p>&#xFFFD;&#xFFFD;&#x1AA;&#xFFFD;&#xFFFD;&#xFFFD;&#xB6;&#x3F6;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x434;&#xFFFD;&#x2FD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x2E3;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x22B;&#xFFFD;&#xFFFD;&#x22B;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x437;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x5B6;&#xFFFD;&#xFFFD;&#xFFFD;&#x32B;&#xFFFD;&#xFFFD;&#xFFFD;&#x2F8;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x4BB;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x22B;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xA863;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x43A;&#x736;&#xFFFD;&#xFFFD;&#x637;&#xFFFD;&#xFFFD;&#xFFFD;&#xFB;&#xFFFD;&#xFFFD;&#x434;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;Choreographer&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x7E3;&#xFFFD;&#xFFFD;&#xFFFD;View&#xFFFD;&#xFFFD;measure&#xFFFD;&#xFFFD;layout&#xFFFD;&#xFFFD;draw&#xFFFD;&#x139;&#xFFFD;&#xFFFD;&#x323;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x438;&#xFFFD;&#xFFFD;&#xFFFD;&#x3F8;&#xFFFD;&#x6B5;&#xFFFD;&#x2B5;&#xFFFD;&#xFFFD;&#xFFFD;&#x53C;&#xFFFD;&#xFFFD;&#x5F2;&#xFFFD;native&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x13E;&#xFFFD;&#xFFFD;&#xFFFD;&#x2B5;&#xFFFD;&#x5A1;&#xFFFD;<br>&#xB7;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x536;&#xFFFD;&#x28EC;&#x36C;&#x5BE;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;&#x16C;&#xFFFD;&#xFFFD;&#xFFFD;&#xFFFD;<br><img src="http://upload-images.jianshu.io/upload_images/5720362-28ce1fb057e1ca1a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
</blockquote>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/11/16/Activity从创建到显示的整个过程/" rel="next" title="Activity从创建到显示的整个过程">
                <i class="fa fa-chevron-left"></i> Activity从创建到显示的整个过程
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/favicon.png"
               alt="Nick Kang" />
          <p class="site-author-name" itemprop="name">Nick Kang</p>
          <p class="site-description motion-element" itemprop="description">风轻云淡，勿忘本心</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#д��j���L�"><span class="nav-number">1.</span> <span class="nav-text">д��ǰ���Ļ�</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#1-��WindowManager��addView˵��"><span class="nav-number">2.</span> <span class="nav-text">1. ��WindowManager��addView˵��</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-WindowManagerGlobal��addView����"><span class="nav-number">3.</span> <span class="nav-text">2. WindowManagerGlobal��addView����</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-ViewRootImpl��setView����"><span class="nav-number">4.</span> <span class="nav-text">3. ViewRootImpl��setView����</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-Session��addToDisplay"><span class="nav-number">5.</span> <span class="nav-text">4. Session��addToDisplay</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#6-Choreographer��TraversalRunnable�첽����ִ��"><span class="nav-number">6.</span> <span class="nav-text">6. Choreographer��TraversalRunnable�첽����ִ��</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#6-1-relayoutWindow�L���"><span class="nav-number">6.1.</span> <span class="nav-text">6.1 relayoutWindow�Ĺ���</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-2-performMeasure����"><span class="nav-number">6.2.</span> <span class="nav-text">6.2 performMeasure����</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-3-performLayout����"><span class="nav-number">6.3.</span> <span class="nav-text">6.3 performLayout����</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-4-performDraw�L���"><span class="nav-number">6.4.</span> <span class="nav-text">6.4 performDraw�Ĺ���</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#7-д�ں����L�"><span class="nav-number">7.</span> <span class="nav-text">7. д�ں����Ļ�</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Nick Kang</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  




  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

  


</body>
</html>
