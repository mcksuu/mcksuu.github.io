<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Nick, Ksuu" />








  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.png?v=5.1.0" />






<meta name="description" content="&amp;#x5199;&amp;#x5728;&amp;#x524D;&amp;#x9762;&amp;#x7684;&amp;#x8BDD;
&amp;#x4ECA;&amp;#x5929;&amp;#x770B;&amp;#x5230;&amp;#x4E00;&amp;#x4E2A;&amp;#x65B0;&amp;#x95FB;&amp;#xFF0C;&amp;#x5173;&amp;#x4E8E;&amp;#x867E;&amp;#x7C73;&amp;#x97F3;&amp;#x4E50;&amp;#x7684;&amp;#x7A0B;&amp;#x5E8F;&amp;#x5458">
<meta property="og:type" content="article">
<meta property="og:title" content="Activity显示到Window的过程">
<meta property="og:url" content="https://mcksuu.github.io/2017/11/28/Activity显示到Window的过程/index.html">
<meta property="og:site_name" content="McKsuu">
<meta property="og:description" content="&amp;#x5199;&amp;#x5728;&amp;#x524D;&amp;#x9762;&amp;#x7684;&amp;#x8BDD;
&amp;#x4ECA;&amp;#x5929;&amp;#x770B;&amp;#x5230;&amp;#x4E00;&amp;#x4E2A;&amp;#x65B0;&amp;#x95FB;&amp;#xFF0C;&amp;#x5173;&amp;#x4E8E;&amp;#x867E;&amp;#x7C73;&amp;#x97F3;&amp;#x4E50;&amp;#x7684;&amp;#x7A0B;&amp;#x5E8F;&amp;#x5458">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/5720362-2d07e73a0383c584.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/5720362-41569c08700139d7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/5720362-28ce1fb057e1ca1a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:updated_time" content="2017-11-28T13:53:06.610Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Activity显示到Window的过程">
<meta name="twitter:description" content="&amp;#x5199;&amp;#x5728;&amp;#x524D;&amp;#x9762;&amp;#x7684;&amp;#x8BDD;
&amp;#x4ECA;&amp;#x5929;&amp;#x770B;&amp;#x5230;&amp;#x4E00;&amp;#x4E2A;&amp;#x65B0;&amp;#x95FB;&amp;#xFF0C;&amp;#x5173;&amp;#x4E8E;&amp;#x867E;&amp;#x7C73;&amp;#x97F3;&amp;#x4E50;&amp;#x7684;&amp;#x7A0B;&amp;#x5E8F;&amp;#x5458">
<meta name="twitter:image" content="http://upload-images.jianshu.io/upload_images/5720362-2d07e73a0383c584.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://mcksuu.github.io/2017/11/28/Activity显示到Window的过程/"/>





  <title> Activity显示到Window的过程 | McKsuu </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">McKsuu</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle">McKsuu</p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://mcksuu.github.io/2017/11/28/Activity显示到Window的过程/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Nick Kang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/favicon.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="McKsuu">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="McKsuu" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Activity显示到Window的过程
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="post.created" itemprop="dateCreated datePublished" datetime="2017-11-28T21:51:30+08:00">
                2017-11-28
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="&#x5199;&#x5728;&#x524D;&#x9762;&#x7684;&#x8BDD;"><a href="#&#x5199;&#x5728;&#x524D;&#x9762;&#x7684;&#x8BDD;" class="headerlink" title="&#x5199;&#x5728;&#x524D;&#x9762;&#x7684;&#x8BDD;"></a>&#x5199;&#x5728;&#x524D;&#x9762;&#x7684;&#x8BDD;</h1><blockquote>
<p>&#x4ECA;&#x5929;&#x770B;&#x5230;&#x4E00;&#x4E2A;&#x65B0;&#x95FB;&#xFF0C;&#x5173;&#x4E8E;&#x867E;&#x7C73;&#x97F3;&#x4E50;&#x7684;&#x7A0B;&#x5E8F;&#x5458;&#x5199;&#x7684;&#x6CE8;&#x91CA;&#x3002;<br><img src="http://upload-images.jianshu.io/upload_images/5720362-2d07e73a0383c584.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""><br>&#x597D;&#x50CF;&#x56FE;&#x90FD;&#x7EFF;&#x4E86;&#xFF0C;&#x7A81;&#x7136;&#x95F4;&#x60F3;&#x8D77;&#x5728;&#x6211;&#x66FE;&#x7ECF;&#x8001;&#x5927;&#x7684;&#x5F71;&#x54CD;&#x4E0B;&#xFF0C;&#x6211;&#x7684;Log&#x8F93;&#x51FA;&#x5DF2;&#x7ECF;&#x53D8;&#x6210;&#x4E86;fxxk&#x3002;&#x3002;&#x8FD9;&#x6837;&#x4E0D;&#x597D;&#xFF0C;&#x4E0D;&#x597D;&#x3002;&#x8981;&#x6539;&#x7684;&#xFF0C;&#x6539;&#x6539;&#x6539;&#x3002;<br><img src="http://upload-images.jianshu.io/upload_images/5720362-41569c08700139d7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
</blockquote>
<hr>
<h1 id="1-&#x4ECE;WindowManager&#x7684;addView&#x8BF4;&#x8D77;"><a href="#1-&#x4ECE;WindowManager&#x7684;addView&#x8BF4;&#x8D77;" class="headerlink" title="1. &#x4ECE;WindowManager&#x7684;addView&#x8BF4;&#x8D77;"></a>1. &#x4ECE;WindowManager&#x7684;addView&#x8BF4;&#x8D77;</h1><blockquote>
<p>&#x4E0A;&#x6B21;&#x6211;&#x4EEC;&#x5927;&#x81F4;&#x5206;&#x6790;&#x4E86;Activity&#x4ECE;&#x521B;&#x5EFA;&#x5230;&#x663E;&#x793A;&#x7684;&#x8FC7;&#x7A0B;&#xFF0C;&#x5F53;&#x65F6;&#x53EA;&#x662F;&#x7B80;&#x5355;&#x5206;&#x6790;&#x4E86;&#x4E0B;&#x3002;&#x6700;&#x7EC8;&#x7684;&#x663E;&#x793A;&#x8FC7;&#x7A0B;&#x8FD8;&#x662F;&#x901A;&#x8FC7;WindowManager&#x7684;addView&#x6DFB;&#x52A0;&#x5230;Window&#x4E0A;&#x7684;&#x3002;WindowManager&#x662F;&#x4E2A;&#x63A5;&#x53E3;&#xFF0C;&#x7EE7;&#x627F;&#x4E86;ViewManager&#xFF0C;&#x5176;&#x6700;&#x7EC8;&#x7684;&#x5B9E;&#x73B0;&#x7C7B;&#x662F;WindowManagerImpl&#xFF0C;&#x5148;&#x6765;&#x770B;&#x4E0B;WindowManagerImpl&#x7684;addView&#x65B9;&#x6CD5;&#x3002;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">ActivityThread.java</div><div class="line">if (a.mVisibleFromClient &amp;&amp; !a.mWindowAdded) {</div><div class="line">	a.mWindowAdded = true;</div><div class="line">	wm.addView(decor, l);</div><div class="line">}</div><div class="line">WindowManagerImpl.java</div><div class="line">@Override</div><div class="line">public void addView(@NonNull View view, @NonNull ViewGroup.LayoutParams params) {</div><div class="line">	applyDefaultToken(params);</div><div class="line">	//&#x8C03;&#x7528;&#x4E86;WindowManagerGlobal&#x7684;addView&#x65B9;&#x6CD5;</div><div class="line">	mGlobal.addView(view, params, mContext.getDisplay(), mParentWindow);</div><div class="line">}</div><div class="line">private void applyDefaultToken(@NonNull ViewGroup.LayoutParams params) {</div><div class="line">	// Only use the default token if we don&apos;t have a parent window.</div><div class="line">	if (mDefaultToken != null &amp;&amp; mParentWindow == null) {</div><div class="line">		//&#x5224;&#x65AD;params</div><div class="line">		if (!(params instanceof WindowManager.LayoutParams)) {</div><div class="line">			throw new IllegalArgumentException(&quot;Params must be WindowManager.LayoutParams&quot;);</div><div class="line">		}</div><div class="line"></div><div class="line">		// Only use the default token if we don&apos;t already have a token.</div><div class="line">		//&#x7ED9;params&#x8BBE;&#x7F6E;token</div><div class="line">		final WindowManager.LayoutParams wparams = (WindowManager.LayoutParams) params;</div><div class="line">		if (wparams.token == null) {</div><div class="line">			wparams.token = mDefaultToken;</div><div class="line">		}</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure></p>
<p>&#x4E0A;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x662F;&#x5148;&#x7ED9;&#x5F53;&#x524D;&#x7684;params&#x8BBE;&#x7F6E;&#x4E86;token&#xFF0C;&#x63A5;&#x7740;&#x8C03;&#x7528;&#x4E86;WindowManagerGlobal&#x7684;<code>addView</code>&#x65B9;&#x6CD5;&#x3002;</p>
</blockquote>
<hr>
<h1 id="2-WindowManagerGlobal&#x7684;addView&#x65B9;&#x6CD5;"><a href="#2-WindowManagerGlobal&#x7684;addView&#x65B9;&#x6CD5;" class="headerlink" title="2. WindowManagerGlobal&#x7684;addView&#x65B9;&#x6CD5;"></a>2. WindowManagerGlobal&#x7684;addView&#x65B9;&#x6CD5;</h1><blockquote>
<p>&#x4E0A;&#x9762;&#x8BF4;&#x5230;&#x6211;&#x4EEC;&#x5BF9;&#x5F53;&#x524D;&#x7684;params&#x8BBE;&#x7F6E;&#x4E86;token&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x8C03;&#x7528;&#x4E86;WindowManagerGlobal&#x7684;<code>addView</code>&#x65B9;&#x6CD5;&#x3002;<br>&#x5728;WindowManagerGlobal&#x7684;addView&#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x9996;&#x5148;&#x8FDB;&#x884C;&#x7684;&#x662F;&#x5BF9;&#x53C2;&#x6570;&#x7684;&#x6821;&#x9A8C;&#xFF0C;&#x5305;&#x62EC;&#x4E86;&#x7C7B;&#x578B;&#x4EE5;&#x53CA;null&#x7684;&#x6821;&#x9A8C;&#x3002;&#x5982;&#x679C;&#x4E0D;&#x901A;&#x8FC7;&#xFF0C;&#x5219;throw Exception&#x3002;&#x63A5;&#x7740;&#x5728;&#x7F13;&#x5B58;&#x7684;view&#x4E2D;&#x53BB;&#x5BFB;&#x627E;&#x5F53;&#x524D;&#x7684;decorView&#x662F;&#x5426;&#x5DF2;&#x7ECF;&#x5B58;&#x5728;&#xFF0C;&#x5982;&#x679C;&#x5DF2;&#x7ECF;&#x5B58;&#x5728;&#x5219;&#x9700;&#x8981;&#x5224;&#x65AD;&#x5176;&#x662F;&#x5426;&#x6B63;&#x5728;&#x201C;&#x6B7B;&#x4EA1;&#x201D;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x662F;&#xFF0C;&#x8FD9;&#x629B;&#x51FA;&#x5F02;&#x5E38;&#x3002;&#x63A5;&#x7740;&#x9700;&#x8981;&#x6839;&#x636E;LayoutParams&#x7684;type&#x6765;&#x5224;&#x65AD;&#x7A97;&#x53E3;&#x7684;&#x7C7B;&#x578B;&#xFF0C;&#x9ED8;&#x8BA4;&#x7684;&#x662F;<strong>TYPE_APPLICATION</strong>&#x5373;&#x666E;&#x901A;&#x5E94;&#x7528;&#x7A97;&#x53E3;&#x7C7B;&#x578B;&#x3002;&#x5982;&#x679C;&#x662F;&#x5B50;&#x7A97;&#x53E3;&#x7C7B;&#x578B;&#xFF0C;&#x5219;&#x9700;&#x8981;&#x6839;&#x636E;&#x5176;token&#x6765;&#x67E5;&#x627E;&#x5176;&#x7236;&#x7A97;&#x53E3;&#x3002;&#x63A5;&#x7740;&#x9700;&#x8981;&#x521B;&#x5EFA;ViewRootImpl&#x5BF9;&#x8C61;&#xFF0C;&#x5E76;&#x5C06;decorView&#x3001;root&#x3001;wparams&#x4EE5;&#x53CA;&#x6DFB;&#x52A0;&#x5230;&#x7F13;&#x5B58;&#x4E2D;&#x3002;&#x4E0B;&#x9762;&#x662F;&#x4EE3;&#x7801;&#xFF1A;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div></pre></td><td class="code"><pre><div class="line">WindowManagerGlobal.java</div><div class="line">public void addView(View view, ViewGroup.LayoutParams params,</div><div class="line">		Display display, Window parentWindow) {</div><div class="line">	//&#x53C2;&#x6570;&#x68C0;&#x67E5;</div><div class="line">	if (view == null) {</div><div class="line">		throw new IllegalArgumentException(&quot;view must not be null&quot;);</div><div class="line">	}</div><div class="line">	if (display == null) {</div><div class="line">		throw new IllegalArgumentException(&quot;display must not be null&quot;);</div><div class="line">	}</div><div class="line">	if (!(params instanceof WindowManager.LayoutParams)) {</div><div class="line">		throw new IllegalArgumentException(&quot;Params must be WindowManager.LayoutParams&quot;);</div><div class="line">	}</div><div class="line"></div><div class="line">	final WindowManager.LayoutParams wparams = (WindowManager.LayoutParams) params;</div><div class="line">	if (parentWindow != null) {</div><div class="line">		parentWindow.adjustLayoutParamsForSubWindow(wparams);</div><div class="line">	} else {</div><div class="line">		// If there&apos;s no parent, then hardware acceleration for this view is</div><div class="line">		// set from the application&apos;s hardware acceleration setting.</div><div class="line">		final Context context = view.getContext();</div><div class="line">		if (context != null</div><div class="line">				&amp;&amp; (context.getApplicationInfo().flags</div><div class="line">						&amp; ApplicationInfo.FLAG_HARDWARE_ACCELERATED) != 0) {</div><div class="line">			wparams.flags |= WindowManager.LayoutParams.FLAG_HARDWARE_ACCELERATED;</div><div class="line">		}</div><div class="line">	}</div><div class="line">	</div><div class="line">	ViewRootImpl root;</div><div class="line">	View panelParentView = null;</div><div class="line"></div><div class="line">	synchronized (mLock) {</div><div class="line">		//&#x6DFB;&#x52A0;&#x7CFB;&#x7EDF;&#x5C5E;&#x6027;&#x6539;&#x53D8;&#x7684;callback</div><div class="line">		// Start watching for system property changes.</div><div class="line">		if (mSystemPropertyUpdater == null) {</div><div class="line">			mSystemPropertyUpdater = new Runnable() {</div><div class="line">				@Override public void run() {</div><div class="line">					synchronized (mLock) {</div><div class="line">						for (int i = mRoots.size() - 1; i &gt;= 0; --i) {</div><div class="line">							mRoots.get(i).loadSystemProperties();</div><div class="line">						}</div><div class="line">					}</div><div class="line">				}</div><div class="line">			};</div><div class="line">			SystemProperties.addChangeCallback(mSystemPropertyUpdater);</div><div class="line">		}</div><div class="line">		//&#x4ECE;&#x7F13;&#x5B58;&#x7684;view&#x4E2D;&#x5BFB;&#x627E;&#x662F;&#x5426;&#x5F53;&#x524D;&#x7684;decorView&#x5DF2;&#x7ECF;&#x5B58;&#x5728;</div><div class="line">		int index = findViewLocked(view, false);</div><div class="line">		//index &gt;= 0 &#x5219;&#x8BF4;&#x660E;&#x5DF2;&#x7ECF;&#x5B58;&#x5728;&#x4E86;&#xFF0C;&#x6240;&#x4EE5;&#x9700;&#x8981;&#x53BB;&#x8BA9;&#x5B83;&#x9500;&#x6BC1;</div><div class="line">		if (index &gt;= 0) {</div><div class="line">			//&#x6B63;&#x5728;&#x9500;&#x6BC1;&#x7684;view&#x4E2D;&#x662F;&#x5426;&#x5305;&#x542B;&#xFF0C;&#x5982;&#x679C;&#x6709;&#x7684;&#x8BDD;&#xFF0C;&#x8C03;&#x7528;&#x5176;doDie()&#x65B9;&#x6CD5;</div><div class="line">			if (mDyingViews.contains(view)) {</div><div class="line">				// Don&apos;t wait for MSG_DIE to make it&apos;s way through root&apos;s queue.</div><div class="line">				mRoots.get(index).doDie();</div><div class="line">			} else {</div><div class="line">				//&#x629B;&#x51FA;&#x5F02;&#x5E38;</div><div class="line">				throw new IllegalStateException(&quot;View &quot; + view</div><div class="line">						+ &quot; has already been added to the window manager.&quot;);</div><div class="line">			}</div><div class="line">			// The previous removeView() had not completed executing. Now it has.</div><div class="line">		}</div><div class="line"></div><div class="line">		// If this is a panel window, then find the window it is being</div><div class="line">		// attached to for future reference.</div><div class="line">		// &#x5224;&#x65AD;&#x5F53;&#x524D;&#x7684;LayoutParams&#x7684;type&#x7684;&#x7C7B;&#x578B;&#xFF0C;&#x5982;&#x679C;&#x5B83;&#x662F;&#x5B50;&#x7A97;&#x53E3;&#xFF0C;&#x90A3;&#x4E48;&#x9700;&#x8981;&#x53BB;&#x627E;&#x5230;&#x5B83;&#x7684;&#x7236;&#x7A97;&#x53E3;</div><div class="line">		if (wparams.type &gt;= WindowManager.LayoutParams.FIRST_SUB_WINDOW &amp;&amp;</div><div class="line">				wparams.type &lt;= WindowManager.LayoutParams.LAST_SUB_WINDOW) {</div><div class="line">			final int count = mViews.size();</div><div class="line">			for (int i = 0; i &lt; count; i++) {</div><div class="line">				if (mRoots.get(i).mWindow.asBinder() == wparams.token) {</div><div class="line">					panelParentView = mViews.get(i);</div><div class="line">				}</div><div class="line">			}</div><div class="line">		}</div><div class="line">		//&#x521B;&#x5EFA;ViewRootImpl</div><div class="line">		root = new ViewRootImpl(view.getContext(), display);</div><div class="line">		//&#x8BBE;&#x7F6E;LayoutParams</div><div class="line">		view.setLayoutParams(wparams);</div><div class="line">		//&#x6DFB;&#x52A0;&#x5230;&#x7F13;&#x5B58;&#x4E2D;</div><div class="line">		mViews.add(view);</div><div class="line">		mRoots.add(root);</div><div class="line">		mParams.add(wparams);</div><div class="line">	}</div><div class="line"></div><div class="line">	// do this last because it fires off messages to start doing things</div><div class="line">	try {</div><div class="line">		//&#x901A;&#x8FC7;ViewRootImpl&#x53BB;&#x8BBE;&#x7F6E;view&#xFF0C;&#x4F20;&#x5165;decorView&#xFF0C;LayoutParams&#x4EE5;&#x53CA;&#x7236;&#x7A97;&#x53E3;</div><div class="line">		root.setView(view, wparams, panelParentView);</div><div class="line">	} catch (RuntimeException e) {</div><div class="line">		// BadTokenException or InvalidDisplayException, clean up.</div><div class="line">		synchronized (mLock) {</div><div class="line">			final int index = findViewLocked(view, false);</div><div class="line">			if (index &gt;= 0) {</div><div class="line">				removeViewLocked(index, true);</div><div class="line">			}</div><div class="line">		}</div><div class="line">		throw e;</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure></p>
</blockquote>
<hr>
<h1 id="3-ViewRootImpl&#x7684;setView&#x65B9;&#x6CD5;"><a href="#3-ViewRootImpl&#x7684;setView&#x65B9;&#x6CD5;" class="headerlink" title="3. ViewRootImpl&#x7684;setView&#x65B9;&#x6CD5;"></a>3. ViewRootImpl&#x7684;setView&#x65B9;&#x6CD5;</h1><blockquote>
<p>ViewRootImpl&#x7684;setView&#x65B9;&#x6CD5;&#x6BD4;&#x8F83;&#x957F;&#xFF0C;&#x524D;&#x4E00;&#x90E8;&#x5206;&#x4E0D;&#x7528;&#x591A;&#x8BF4;&#xFF0C;&#x5176;&#x4E2D;&#x6709;&#x4E00;&#x90E8;&#x5206;&#x6BD4;&#x8F83;&#x91CD;&#x8981;&#x7684;&#x662F;&#x5BF9;<code>mSurfaceHolderCallback</code>&#x7684;&#x8D4B;&#x503C;&#x64CD;&#x4F5C;&#x3002;&#x8FD9;&#x91CC;&#x9762;&#x9700;&#x8981;&#x770B;&#x5230;&#x7684;&#x662F;<code>DecorView extends FrameLayout implements RootViewSurfaceTaker</code>&#xFF0C;&#x4F46;&#x662F;willYouTakeTheSurface&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x8FD4;&#x56DE;&#x7684;&#x9ED8;&#x8BA4;&#x662F;null&#xFF0C;&#x5982;&#x679C;&#x9700;&#x8981;&#x8BBE;&#x7F6E;&#x53EF;&#x4EE5;&#x5728;Activity&#x4E2D;&#x4F7F;&#x7528;<code>getWindow().takeSurface()</code>&#x8BBE;&#x7F6E;&#x3002;&#x63A5;&#x7740;&#x8C03;&#x7528;&#x4E86;<code>requestLayout()</code>&#x65B9;&#x6CD5;&#xFF0C;&#x53BB;&#x8BF7;&#x6C42;&#x5F00;&#x59CB;&#x5E03;&#x5C40;&#xFF0C;&#x8FD9;&#x91CC;&#x9762;&#x901A;&#x8FC7;&#x7F16;&#x821E;&#x8005;Choreographer&#x6765;&#x8FDB;&#x884C;&#x7684;&#x5F02;&#x6B65;&#x64CD;&#x4F5C;&#xFF0C;&#x6574;&#x4E2A;&#x8FC7;&#x7A0B;&#x4E5F;&#x6BD4;&#x8F83;&#x7E41;&#x7410;&#x3002;&#x540E;&#x9762;&#x662F;&#x5BF9;&#x8F93;&#x5165;&#x901A;&#x9053;&#x7684;&#x5EFA;&#x7ACB;&#xFF0C;&#x901A;&#x8FC7;Session&#x5C06;IWindow&#x6DFB;&#x52A0;&#x5230;WMS&#x4E2D;&#x3002;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div></pre></td><td class="code"><pre><div class="line">public void setView(View view, WindowManager.LayoutParams attrs, View panelParentView) {</div><div class="line">	synchronized (this) {</div><div class="line">		if (mView == null) {</div><div class="line">			mView = view;</div><div class="line"></div><div class="line">			mAttachInfo.mDisplayState = mDisplay.getState();</div><div class="line">			mDisplayManager.registerDisplayListener(mDisplayListener, mHandler);</div><div class="line"></div><div class="line">			mViewLayoutDirectionInitial = mView.getRawLayoutDirection();</div><div class="line">			mFallbackEventHandler.setView(view);</div><div class="line">			mWindowAttributes.copyFrom(attrs);</div><div class="line">			if (mWindowAttributes.packageName == null) {</div><div class="line">				mWindowAttributes.packageName = mBasePackageName;</div><div class="line">			}</div><div class="line">			attrs = mWindowAttributes;</div><div class="line">			setTag();</div><div class="line"></div><div class="line">			// Keep track of the actual window flags supplied by the client.</div><div class="line">			mClientWindowLayoutFlags = attrs.flags;</div><div class="line"></div><div class="line">			setAccessibilityFocus(null, null);</div><div class="line">			//&#x5F53;&#x524D;&#x7684;view&#x662F;decorView&#xFF0C;&#x800C;&#x901A;&#x8FC7;&#x6E90;&#x7801;&#x53EF;&#x4EE5;&#x770B;&#x5230;	DecorView extends FrameLayout implements RootViewSurfaceTaker, WindowCallbacks</div><div class="line">			//&#x6240;&#x4EE5;&#x8FD9;&#x4E2A;&#x6761;&#x4EF6;&#x6210;&#x7ACB;&#xFF0C;&#x4E0D;&#x8FC7;willYouTakeTheSurface&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x53BB;&#x83B7;&#x5F97;Callback2&#x7684;&#x65F6;&#xFF0C;</div><div class="line">			//&#x5B9E;&#x9645;&#x4E0A;&#x83B7;&#x53D6;&#x7684;&#x662F;PhoneWindow&#x7684;mTakeSurfaceCallback&#xFF0C;&#x8FD9;&#x4E2A;mTakeSurfaceCallback&#x7684;&#x8BBE;&#x7F6E;&#x662F;&#x901A;&#x8FC7;getWindow().takeSurface()&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#x8BBE;&#x7F6E;&#x3002;</div><div class="line">			if (view instanceof RootViewSurfaceTaker) {</div><div class="line">				//&#x9ED8;&#x8BA4;&#x7684;&#x4E3A;null</div><div class="line">				mSurfaceHolderCallback =</div><div class="line">						((RootViewSurfaceTaker)view).willYouTakeTheSurface();</div><div class="line">				if (mSurfaceHolderCallback != null) {</div><div class="line">					mSurfaceHolder = new TakenSurfaceHolder();</div><div class="line">					mSurfaceHolder.setFormat(PixelFormat.UNKNOWN);</div><div class="line">				}</div><div class="line">			}</div><div class="line"></div><div class="line">			// Compute surface insets required to draw at specified Z value.</div><div class="line">			// TODO: Use real shadow insets for a constant max Z.</div><div class="line">			if (!attrs.hasManualSurfaceInsets) {</div><div class="line">				attrs.setSurfaceInsets(view, false /*manual*/, true /*preservePrevious*/);</div><div class="line">			}</div><div class="line"></div><div class="line">			CompatibilityInfo compatibilityInfo =</div><div class="line">					mDisplay.getDisplayAdjustments().getCompatibilityInfo();</div><div class="line">			mTranslator = compatibilityInfo.getTranslator();</div><div class="line">			//&#x5982;&#x679C;&#x8FD9;&#x4E2A;&#x5E94;&#x7528;&#x6CA1;&#x6709;&#x62E5;&#x6709;&#x81EA;&#x5DF1;&#x7684;surface&#xFF0C;&#x90A3;&#x4E48;&#x9700;&#x8981;&#x5F00;&#x542F;&#x786C;&#x4EF6;&#x52A0;&#x901F;</div><div class="line">			// If the application owns the surface, don&apos;t enable hardware acceleration</div><div class="line">			if (mSurfaceHolder == null) {</div><div class="line">				enableHardwareAcceleration(attrs);</div><div class="line">			}</div><div class="line"></div><div class="line">			......</div><div class="line">			//&#x8BBE;&#x7F6E;&#x4E3A;&#x5DF2;&#x7ECF;&#x6DFB;&#x52A0;</div><div class="line">			mAdded = true;</div><div class="line">			int res; /* = WindowManagerImpl.ADD_OKAY; */</div><div class="line"></div><div class="line">			// Schedule the first layout -before- adding to the window</div><div class="line">			// manager, to make sure we do the relayout before receiving</div><div class="line">			// any other events from the system.</div><div class="line">			//&#x5F00;&#x59CB;&#x8BF7;&#x6C42;layout&#xFF0C;layout&#x7684;&#x8FC7;&#x7A0B;&#x662F;&#x901A;&#x8FC7;&#x7F16;&#x821E;&#x8005;Choreographer&#x6765;&#x8FDB;&#x884C;&#x7684;&#x5F02;&#x6B65;&#x64CD;&#x4F5C;</div><div class="line">			requestLayout();</div><div class="line">			// &#x8F93;&#x5165;&#x901A;&#x9053;&#x7684;&#x5EFA;&#x7ACB;</div><div class="line">			if ((mWindowAttributes.inputFeatures</div><div class="line">					&amp; WindowManager.LayoutParams.INPUT_FEATURE_NO_INPUT_CHANNEL) == 0) {</div><div class="line">				mInputChannel = new InputChannel();</div><div class="line">			}</div><div class="line">			mForceDecorViewVisibility = (mWindowAttributes.privateFlags</div><div class="line">					&amp; PRIVATE_FLAG_FORCE_DECOR_VIEW_VISIBILITY) != 0;</div><div class="line">			try {</div><div class="line">				mOrigWindowType = mWindowAttributes.type;</div><div class="line">				mAttachInfo.mRecomputeGlobalAttributes = true;</div><div class="line">				collectViewAttributes();</div><div class="line">				//&#x901A;&#x8FC7;windowSession&#x6DFB;&#x52A0;&#x663E;&#x793A;&#xFF0C;&#x8FD9;&#x91CC;&#x9762;&#x4E3B;&#x8981;&#x662F;&#x521B;&#x5EFA;SurfaceSession&#xFF0C;SurfaceSession&#x7528;&#x6765;&#x8FDE;&#x63A5;surface flinger</div><div class="line">				//&#x540E;&#x9762;&#x4F1A;&#x901A;&#x8FC7;native&#x521B;&#x5EFA;SurfaceControl&#x65F6;&#x5F53;&#x4F5C;&#x53C2;&#x6570;&#x4F20;&#x5165;</div><div class="line">				res = mWindowSession.addToDisplay(mWindow, mSeq, mWindowAttributes,</div><div class="line">						getHostVisibility(), mDisplay.getDisplayId(),</div><div class="line">						mAttachInfo.mContentInsets, mAttachInfo.mStableInsets,</div><div class="line">						mAttachInfo.mOutsets, mInputChannel);</div><div class="line">			} catch (RemoteException e) {</div><div class="line">				mAdded = false;</div><div class="line">				mView = null;</div><div class="line">				mAttachInfo.mRootView = null;</div><div class="line">				mInputChannel = null;</div><div class="line">				mFallbackEventHandler.setView(null);</div><div class="line">				unscheduleTraversals();</div><div class="line">				setAccessibilityFocus(null, null);</div><div class="line">				throw new RuntimeException(&quot;Adding window failed&quot;, e);</div><div class="line">			} finally {</div><div class="line">				if (restore) {</div><div class="line">					attrs.restore();</div><div class="line">				}</div><div class="line">			}</div><div class="line"></div><div class="line">			if (mTranslator != null) {</div><div class="line">				mTranslator.translateRectInScreenToAppWindow(mAttachInfo.mContentInsets);</div><div class="line">			}</div><div class="line">			mPendingOverscanInsets.set(0, 0, 0, 0);</div><div class="line">			mPendingContentInsets.set(mAttachInfo.mContentInsets);</div><div class="line">			mPendingStableInsets.set(mAttachInfo.mStableInsets);</div><div class="line">			mPendingVisibleInsets.set(0, 0, 0, 0);</div><div class="line">			mAttachInfo.mAlwaysConsumeNavBar =</div><div class="line">					(res &amp; WindowManagerGlobal.ADD_FLAG_ALWAYS_CONSUME_NAV_BAR) != 0;</div><div class="line">			mPendingAlwaysConsumeNavBar = mAttachInfo.mAlwaysConsumeNavBar;</div><div class="line">			if (DEBUG_LAYOUT) Log.v(mTag, &quot;Added window &quot; + mWindow);</div><div class="line">			// &#x8FD4;&#x56DE;&#x7684;&#x7ED3;&#x679C;&#x4E0D;&#x662F;&#x6210;&#x529F;&#xFF0C;&#x5219;&#x6839;&#x636E;&#x7ED3;&#x679C;&#x629B;&#x51FA;&#x5F02;&#x5E38;</div><div class="line">			if (res &lt; WindowManagerGlobal.ADD_OKAY) {</div><div class="line">				mAttachInfo.mRootView = null;</div><div class="line">				mAdded = false;</div><div class="line">				mFallbackEventHandler.setView(null);</div><div class="line">				unscheduleTraversals();</div><div class="line">				setAccessibilityFocus(null, null);</div><div class="line">				switch (res) {</div><div class="line">					......</div><div class="line">				}</div><div class="line">				throw new RuntimeException(</div><div class="line">						&quot;Unable to add window -- unknown error code &quot; + res);</div><div class="line">			}</div><div class="line">			// &#x8F93;&#x5165;&#x4E8B;&#x4EF6;&#x7684;callback&#xFF0C;&#x4E00;&#x822C;&#x60C5;&#x51B5;&#x4E0B;&#x90FD;&#x4E3A;null</div><div class="line">			if (view instanceof RootViewSurfaceTaker) {</div><div class="line">				mInputQueueCallback =</div><div class="line">					((RootViewSurfaceTaker)view).willYouTakeTheInputQueue();</div><div class="line">			}</div><div class="line">			// &#x6CE8;&#x518C;&#x8F93;&#x5165;&#x4E8B;&#x4EF6;&#x7684;&#x76D1;&#x542C;</div><div class="line">			if (mInputChannel != null) {</div><div class="line">				if (mInputQueueCallback != null) {</div><div class="line">					mInputQueue = new InputQueue();</div><div class="line">					mInputQueueCallback.onInputQueueCreated(mInputQueue);</div><div class="line">				}</div><div class="line">				mInputEventReceiver = new WindowInputEventReceiver(mInputChannel,</div><div class="line">						Looper.myLooper());</div><div class="line">			}</div><div class="line">			//&#x8BA9;&#x5F53;&#x524D;&#x7684;ViewRootImpl&#x6210;&#x4E3A;view&#x7684;&#x7236;&#x4EB2;&#x3002;&#x3002;</div><div class="line">			view.assignParent(this);</div><div class="line">			mAddedTouchMode = (res &amp; WindowManagerGlobal.ADD_FLAG_IN_TOUCH_MODE) != 0;</div><div class="line">			mAppVisible = (res &amp; WindowManagerGlobal.ADD_FLAG_APP_VISIBLE) != 0;</div><div class="line"></div><div class="line">			if (mAccessibilityManager.isEnabled()) {</div><div class="line">				mAccessibilityInteractionConnectionManager.ensureConnection();</div><div class="line">			}</div><div class="line"></div><div class="line">			if (view.getImportantForAccessibility() == View.IMPORTANT_FOR_ACCESSIBILITY_AUTO) {</div><div class="line">				view.setImportantForAccessibility(View.IMPORTANT_FOR_ACCESSIBILITY_YES);</div><div class="line">			}</div><div class="line"></div><div class="line">			// Set up the input pipeline.</div><div class="line">			......</div><div class="line">		}</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure></p>
</blockquote>
<hr>
<h1 id="4-Session&#x7684;addToDisplay"><a href="#4-Session&#x7684;addToDisplay" class="headerlink" title="4. Session&#x7684;addToDisplay"></a>4. Session&#x7684;addToDisplay</h1><blockquote>
<p>Session&#x7684;addToDisplay&#x65B9;&#x6CD5;&#x8C03;&#x7528;WMS&#x7684;addWindow&#x65B9;&#x6CD5;&#xFF0C;WMS&#x4E2D;&#x7684;addWindow&#x4E3B;&#x8981;&#x662F;&#x521B;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A;WindowState&#x5BF9;&#x8C61;&#xFF0C;&#x901A;&#x8FC7;&#x5176;<code>attach</code>&#x65B9;&#x6CD5;&#x8C03;&#x7528;Session&#x4E2D;&#x7684;<code>windowAddedLocked</code>&#x65B9;&#x6CD5;&#x521B;&#x5EFA;SurfaceSession&#xFF0C;&#x901A;&#x8FC7;SurfaceSession&#x53EF;&#x4EE5;&#x548C;surface flinger&#x8FDE;&#x63A5;&#x3002;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div></pre></td><td class="code"><pre><div class="line">Session.java:</div><div class="line">@Override</div><div class="line">public int addToDisplay(IWindow window, int seq, WindowManager.LayoutParams attrs,</div><div class="line">		int viewVisibility, int displayId, Rect outContentInsets, Rect outStableInsets,</div><div class="line">		Rect outOutsets, InputChannel outInputChannel) {</div><div class="line">	return mService.addWindow(this, window, seq, attrs, viewVisibility, displayId,</div><div class="line">			outContentInsets, outStableInsets, outOutsets, outInputChannel);</div><div class="line">}</div><div class="line"></div><div class="line">WMS:</div><div class="line">public int addWindow(Session session, IWindow client, int seq,</div><div class="line">		WindowManager.LayoutParams attrs, int viewVisibility, int displayId,</div><div class="line">		Rect outContentInsets, Rect outStableInsets, Rect outOutsets,</div><div class="line">		InputChannel outInputChannel) {</div><div class="line">	int[] appOp = new int[1];</div><div class="line">	//&#x6743;&#x9650;&#x68C0;&#x67E5;&#x5B9E;&#x73B0;&#x7C7B;WindowManagerPolicy</div><div class="line">	int res = mPolicy.checkAddPermission(attrs, appOp);</div><div class="line">	if (res != WindowManagerGlobal.ADD_OKAY) {</div><div class="line">		return res;</div><div class="line">	}</div><div class="line"></div><div class="line">	boolean reportNewConfig = false;</div><div class="line">	WindowState parentWindow = null;</div><div class="line">	long origId;</div><div class="line">	final int callingUid = Binder.getCallingUid();</div><div class="line">	final int type = attrs.type;</div><div class="line"></div><div class="line">	synchronized(mWindowMap) {</div><div class="line">		//&#x9519;&#x8BEF;&#x5904;&#x7406;</div><div class="line">		......</div><div class="line">		</div><div class="line">		AppWindowToken atoken = null;</div><div class="line">		final boolean hasParent = parentWindow != null;</div><div class="line">		// Use existing parent window token for child windows since they go in the same token</div><div class="line">		// as there parent window so we can apply the same policy on them.</div><div class="line">		WindowToken token = displayContent.getWindowToken(</div><div class="line">				hasParent ? parentWindow.mAttrs.token : attrs.token);</div><div class="line">		// If this is a child window, we want to apply the same type checking rules as the</div><div class="line">		// parent window type.</div><div class="line">		final int rootType = hasParent ? parentWindow.mAttrs.type : type;</div><div class="line"></div><div class="line">		boolean addToastWindowRequiresToken = false;</div><div class="line"></div><div class="line">		if (token == null) {</div><div class="line">		//&#x9519;&#x8BEF;&#x5904;&#x7406;</div><div class="line">			......</div><div class="line">			final IBinder binder = attrs.token != null ? attrs.token : client.asBinder();</div><div class="line">			token = new WindowToken(this, binder, type, false, displayContent,</div><div class="line">					session.mCanAddInternalSystemWindow);</div><div class="line">		} else if (rootType &gt;= FIRST_APPLICATION_WINDOW &amp;&amp; rootType &lt;= LAST_APPLICATION_WINDOW) {</div><div class="line">			atoken = token.asAppWindowToken();</div><div class="line">			......</div><div class="line">		} ......//&#x9519;&#x8BEF;&#x5904;&#x7406;</div><div class="line">		} else if (token.asAppWindowToken() != null) {</div><div class="line">			attrs.token = null;</div><div class="line">			token = new WindowToken(this, client.asBinder(), type, false, displayContent,</div><div class="line">					session.mCanAddInternalSystemWindow);</div><div class="line">		}</div><div class="line">		</div><div class="line">		//&#x521B;&#x5EFA;WindowState&#xFF0C;</div><div class="line">		final WindowState win = new WindowState(this, session, client, token, parentWindow,</div><div class="line">				appOp[0], seq, attrs, viewVisibility, session.mUid,</div><div class="line">				session.mCanAddInternalSystemWindow);</div><div class="line">		......</div><div class="line">		</div><div class="line">		//&#x5F00;&#x542F;&#x8F93;&#x5165;&#x901A;&#x9053;</div><div class="line">		final boolean openInputChannels = (outInputChannel != null</div><div class="line">				&amp;&amp; (attrs.inputFeatures &amp; INPUT_FEATURE_NO_INPUT_CHANNEL) == 0);</div><div class="line">		if  (openInputChannels) {</div><div class="line">			win.openInputChannel(outInputChannel);</div><div class="line">		}</div><div class="line"></div><div class="line">		//&#x5173;&#x4E8E;toast&#x7684;&#x4E00;&#x4E2A;&#x5904;&#x7406;</div><div class="line">		......</div><div class="line"></div><div class="line">		res = WindowManagerGlobal.ADD_OKAY;</div><div class="line">		if (mCurrentFocus == null) {</div><div class="line">			mWinAddedSinceNullFocus.add(win);</div><div class="line">		}</div><div class="line"></div><div class="line">		if (excludeWindowTypeFromTapOutTask(type)) {</div><div class="line">			displayContent.mTapExcludedWindows.add(win);</div><div class="line">		}</div><div class="line"></div><div class="line">		origId = Binder.clearCallingIdentity();</div><div class="line">		//&#x8C03;&#x7528;&#x4E86;WindowState&#x7684;attach&#x65B9;&#x6CD5;&#xFF0C;&#x4E0B;&#x9762;&#x6709;&#x8BB2;&#x89E3;</div><div class="line">		win.attach();</div><div class="line">		//&#x5C06;WindowState&#x548C;&#x4F20;&#x5165;&#x7684;IWindow&#x4FDD;&#x5B58;&#x5230;mWindowMap&#x4E2D;</div><div class="line">		mWindowMap.put(client.asBinder(), win);</div><div class="line">		......</div><div class="line"></div><div class="line">	return res;</div><div class="line">}</div><div class="line"></div><div class="line">WindowState.java:</div><div class="line">void attach() {</div><div class="line">	if (localLOGV) Slog.v(TAG, &quot;Attaching &quot; + this + &quot; token=&quot; + mToken);</div><div class="line">	mSession.windowAddedLocked(mAttrs.packageName);</div><div class="line">}</div><div class="line"></div><div class="line">Session.java:</div><div class="line">void windowAddedLocked(String packageName) {</div><div class="line">	//&#x8BBE;&#x7F6E;&#x5305;&#x540D;</div><div class="line">	mPackageName = packageName;</div><div class="line">	mRelayoutTag = &quot;relayoutWindow: &quot; + mPackageName;</div><div class="line">	if (mSurfaceSession == null) {</div><div class="line">		//&#x521B;&#x5EFA;SurfaceSession&#x4E0E;surface flinger&#x8FDE;&#x63A5;</div><div class="line">		mSurfaceSession = new SurfaceSession();</div><div class="line">		</div><div class="line">		mService.mSessions.add(this);</div><div class="line">		if (mLastReportedAnimatorScale != mService.getCurrentAnimatorScale()) {</div><div class="line">			mService.dispatchNewAnimatorScaleLocked(this);</div><div class="line">		}</div><div class="line">	}</div><div class="line">	mNumWindow++;</div><div class="line">}</div></pre></td></tr></table></figure></p>
<p>SurfaceSession&#x662F;&#x901A;&#x8FC7;native&#x5C42;&#x521B;&#x5EFA;&#x7684;&#xFF0C;&#x80FD;&#x529B;&#x4E0D;&#x591F;&#xFF0C;&#x4E0D;&#x505A;&#x5206;&#x6790;&#x3002;</p>
</blockquote>
<hr>
<h1 id="6-Choreographer&#x7684;TraversalRunnable&#x5F02;&#x6B65;&#x65B9;&#x6CD5;&#x6267;&#x884C;"><a href="#6-Choreographer&#x7684;TraversalRunnable&#x5F02;&#x6B65;&#x65B9;&#x6CD5;&#x6267;&#x884C;" class="headerlink" title="6. Choreographer&#x7684;TraversalRunnable&#x5F02;&#x6B65;&#x65B9;&#x6CD5;&#x6267;&#x884C;"></a>6. Choreographer&#x7684;TraversalRunnable&#x5F02;&#x6B65;&#x65B9;&#x6CD5;&#x6267;&#x884C;</h1><blockquote>
<p>ViewRootImpl&#x4E2D;&#x7684;Choreographer&#x901A;&#x8FC7;postCallback&#x65B9;&#x5F0F;&#x5B9E;&#x73B0;&#x5F02;&#x6B65;&#x7684;&#x904D;&#x5386;&#x64CD;&#x4F5C;&#xFF0C;Choreographer&#x4F1A;&#x5728;&#x5E95;&#x5C42;&#x63A5;&#x6536;VSYNC&#xFF08;&#x5782;&#x76F4;&#x540C;&#x6B65;&#xFF09;&#x4FE1;&#x53F7;&#xFF0C;&#x63A5;&#x6536;&#x5782;&#x76F4;&#x540C;&#x6B65;&#x4FE1;&#x53F7;&#x540E;&#x4F1A;&#x6839;&#x636E;&#x7C7B;&#x578B;&#x6765;&#x5224;&#x65AD;&#x5177;&#x4F53;&#x64CD;&#x4F5C;&#x3002;&#x8FD9;&#x91CC;&#x662F;&#x904D;&#x5386;&#x64CD;&#x4F5C;&#xFF0C;&#x4F1A;&#x8C03;&#x7528;TraversalRunnable&#x7684;run&#x65B9;&#x6CD5;&#xFF0C;run&#x65B9;&#x6CD5;&#x4E2D;&#x8C03;&#x7528;&#x4E86;ViewRootImpl&#x7684;doTraversal&#x65B9;&#x6CD5;&#xFF0C;doTraversal&#x65B9;&#x6CD5;&#x8C03;&#x7528;&#x4E86;performTraversals()&#x65B9;&#x6CD5;&#x3002;performTraversals()&#x8FD9;&#x91CC;&#x9762;&#x5C31;&#x662F;&#x771F;&#x6B63;&#x7684;&#x904D;&#x5386;&#x64CD;&#x4F5C;&#x3002;&#x7B80;&#x5316;&#x4E00;&#x4E0B;&#x4EE3;&#x7801;&#xFF08;&#x4EE3;&#x7801;&#x592A;&#x591A;&#x4E86;&#xFF09;&#xFF0C;&#x8FD9;&#x91CC;&#x9762;&#x4E3B;&#x8981;&#x5206;&#x4E3A;&#x56DB;&#x90E8;&#x5206;&#xFF1A;</p>
<ol>
<li><code>relayoutWindow</code>&#xFF0C;&#x8FD9;&#x91CC;&#x4F1A;&#x521B;&#x5EFA;SurfaceControl&#xFF0C;&#x5E76;&#x4E14;&#x5C06;&#x4E4B;&#x524D;&#x7684;SurfaceSession&#x5F53;&#x4F5C;&#x53C2;&#x6570;&#x4F20;&#x5165;&#x3002;</li>
<li>&#x8C03;&#x7528;<code>performMeasure</code>&#x65B9;&#x6CD5;&#xFF0C;&#x5BF9;View&#x8FDB;&#x884C;&#x6D4B;&#x91CF;&#x3002;</li>
<li>&#x8C03;&#x7528;<code>performLayout</code>&#x5BF9;View&#x7684;&#x8FDB;&#x884C;&#x5E03;&#x5C40;&#x3002;</li>
<li>&#x8C03;&#x7528;<code>performDraw</code>&#x8FDB;&#x884C;&#x7ED8;&#x5236;&#x3002;<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">final class TraversalRunnable implements Runnable {</div><div class="line">	@Override</div><div class="line">	public void run() {</div><div class="line">		doTraversal();</div><div class="line">	}</div><div class="line">}</div><div class="line"></div><div class="line">void doTraversal() {</div><div class="line">	......</div><div class="line">		performTraversals();</div><div class="line">	......</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line">private void performTraversals() {</div><div class="line">	// cache mView since it is used so much below...</div><div class="line">	final View host = mView;</div><div class="line">	......</div><div class="line">		try {</div><div class="line">			......</div><div class="line">			//&#x91CD;&#x65B0;&#x5E03;&#x5C40;window&#xFF0C;&#x4E3B;&#x8981;&#x662F;surface&#x7684;&#x521B;&#x5EFA;</div><div class="line">			relayoutResult = relayoutWindow(params, viewVisibility, insetsPending);</div><div class="line">			......</div><div class="line">		} </div><div class="line">		......</div><div class="line">		if (!mStopped || mReportNextDraw) {</div><div class="line">				......</div><div class="line"></div><div class="line">				 // Ask host how big it wants to be</div><div class="line">				 //&#x6D4B;&#x91CF;</div><div class="line">				performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</div><div class="line">				......</div><div class="line">		}</div><div class="line">		......</div><div class="line">	if (didLayout) {</div><div class="line">		//&#x5E03;&#x5C40;</div><div class="line">		performLayout(lp, mWidth, mHeight);</div><div class="line">		......</div><div class="line">	}</div><div class="line">	......</div><div class="line">	if (!cancelDraw &amp;&amp; !newSurface) {</div><div class="line">		//&#x7ED8;&#x5236;</div><div class="line">		performDraw();</div><div class="line">	} </div><div class="line">}</div></pre></td></tr></table></figure>
</li>
</ol>
</blockquote>
<hr>
<h2 id="6-1-relayoutWindow&#x7684;&#x8FC7;&#x7A0B;"><a href="#6-1-relayoutWindow&#x7684;&#x8FC7;&#x7A0B;" class="headerlink" title="6.1 relayoutWindow&#x7684;&#x8FC7;&#x7A0B;"></a>6.1 relayoutWindow&#x7684;&#x8FC7;&#x7A0B;</h2><blockquote>
<p>&#x8FD9;&#x91CC;&#x7684;&#x8FC7;&#x7A0B;&#x662F;&#x6BD4;&#x8F83;&#x591A;&#x7684;&#xFF0C;&#x5206;&#x6B65;&#x6765;&#x8BF4;&#xFF1A;</p>
<ol>
<li><p>&#x8C03;&#x7528;Session&#x7684;relayout</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">ViewRootImpl.java:</div><div class="line">private int relayoutWindow(WindowManager.LayoutParams params, int viewVisibility,</div><div class="line">		boolean insetsPending) throws RemoteException {</div><div class="line">	......</div><div class="line">	//&#x8FD9;&#x91CC;&#x8FD8;&#x662F;&#x901A;&#x8FC7;Session&#x8FDB;&#x884C;relayout&#xFF0C;&#x53EF;&#x4EE5;&#x731C;&#x60F3;Session&#x4E2D;&#x4F1A;&#x8C03;&#x7528;WMS&#x65B9;&#x6CD5;&#x8FDB;&#x884C;&#x771F;&#x6B63;relayout</div><div class="line">	//&#x8FD9;&#x91CC;&#x8BF4;&#x4E0B;&#x53C2;&#x6570;mSurface&#x5373;Surface&#x5BF9;&#x8C61;&#xFF0C;&#x8FD9;&#x4E2A;&#x5BF9;&#x8C61;&#x662F;java&#x5C42;&#x76F4;&#x63A5;new&#x51FA;&#x6765;&#x7684;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#xFF0C;&#x5E76;&#x6CA1;&#x6709;&#x5176;&#x4ED6;&#x64CD;&#x4F5C;&#x3002;</div><div class="line">	//&#x540E;&#x9762;&#x901A;&#x8FC7;new SurfaceControl&#x521B;&#x5EFA;Surface&#x5E76;&#x901A;&#x8FC7;surfaceController.getSurface(outSurface)&#x83B7;&#x5F97;&#x771F;&#x6B63;&#x7684;Surface</div><div class="line">	int relayoutResult = mWindowSession.relayout(</div><div class="line">			mWindow, mSeq, params,</div><div class="line">			(int) (mView.getMeasuredWidth() * appScale + 0.5f),</div><div class="line">			(int) (mView.getMeasuredHeight() * appScale + 0.5f),</div><div class="line">			viewVisibility, insetsPending ? WindowManagerGlobal.RELAYOUT_INSETS_PENDING : 0,</div><div class="line">			mWinFrame, mPendingOverscanInsets, mPendingContentInsets, mPendingVisibleInsets,</div><div class="line">			mPendingStableInsets, mPendingOutsets, mPendingBackDropFrame, mPendingConfiguration,</div><div class="line">			mSurface);</div><div class="line"></div><div class="line">	......</div><div class="line">	return relayoutResult;</div><div class="line">}</div></pre></td></tr></table></figure>
</li>
<li><p>Sessoin&#x4E2D;&#x7684;relayout&#x53C8;&#x53BB;&#x8C03;&#x7528;WMS&#x4E2D;&#x7684;relayoutWindow&#x65B9;&#x6CD5;&#xFF08;&#x6BCF;&#x6B21;&#x90FD;&#x662F;&#x8FD9;&#x4E2A;&#x5957;&#x8DEF;&#xFF09;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">Session.java:</div><div class="line">public int relayout(IWindow window, int seq, WindowManager.LayoutParams attrs,</div><div class="line">		int requestedWidth, int requestedHeight, int viewFlags,</div><div class="line">		int flags, Rect outFrame, Rect outOverscanInsets, Rect outContentInsets,</div><div class="line">		Rect outVisibleInsets, Rect outStableInsets, Rect outsets, Rect outBackdropFrame,</div><div class="line">		MergedConfiguration mergedConfiguration, Surface outSurface) {</div><div class="line">	//&#x679C;&#x4E0D;&#x5176;&#x7136;&#xFF0C;&#x8C03;&#x7528;&#x4E86;WMS&#x7684;relayoutWindow&#x65B9;&#x6CD5;&#xFF0C;</div><div class="line">	int res = mService.relayoutWindow(this, window, seq, attrs,</div><div class="line">			requestedWidth, requestedHeight, viewFlags, flags,</div><div class="line">			outFrame, outOverscanInsets, outContentInsets, outVisibleInsets,</div><div class="line">			outStableInsets, outsets, outBackdropFrame, mergedConfiguration, outSurface);</div><div class="line"></div><div class="line">	return res;</div><div class="line">}</div></pre></td></tr></table></figure>
</li>
<li><p>WMS&#x7684;relayoutWindow&#x65B9;&#x6CD5;&#x901A;&#x8FC7;createSurfaceControl&#x521B;&#x5EFA;SurfaceControl&#xFF0C;&#x5E76;&#x901A;&#x8FC7;WindowSurfaceController.getSurface&#x5C06;&#x4F20;&#x5165;&#x7684;&#x53C2;&#x6570;Surface&#x771F;&#x6B63;&#x8D4B;&#x503C;&#xFF08;copyFrom&#xFF09;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">WMS:</div><div class="line">public int relayoutWindow(Session session, IWindow client, int seq,</div><div class="line">		WindowManager.LayoutParams attrs, int requestedWidth,</div><div class="line">		int requestedHeight, int viewVisibility, int flags,</div><div class="line">		Rect outFrame, Rect outOverscanInsets, Rect outContentInsets,</div><div class="line">		Rect outVisibleInsets, Rect outStableInsets, Rect outOutsets, Rect outBackdropFrame,</div><div class="line">		MergedConfiguration mergedConfiguration, Surface outSurface) {</div><div class="line">			......</div><div class="line">			result = win.relayoutVisibleWindow(mergedConfiguration, result, attrChanges,</div><div class="line">					oldVisibility);</div><div class="line">			try {</div><div class="line">				// &#x8FD9;&#x91CC;&#x521B;&#x5EFA;&#x4E86;SurfaceControl</div><div class="line">				result = createSurfaceControl(outSurface, result, win, winAnimator);</div><div class="line">			} catch (Exception e) {</div><div class="line">				mInputMonitor.updateInputWindowsLw(true /*force*/);</div><div class="line"></div><div class="line">				Slog.w(TAG_WM, &quot;Exception thrown when creating surface for client &quot;</div><div class="line">						 + client + &quot; (&quot; + win.mAttrs.getTitle() + &quot;)&quot;,</div><div class="line">						 e);</div><div class="line">				Binder.restoreCallingIdentity(origId);</div><div class="line">				return 0;</div><div class="line">			}</div><div class="line">			......</div><div class="line">		</div><div class="line">	Binder.restoreCallingIdentity(origId);</div><div class="line">	return result;</div><div class="line">}</div><div class="line"></div><div class="line">WindowStateAnimator.java:</div><div class="line">WindowSurfaceController createSurfaceLocked(int windowType, int ownerUid) {</div><div class="line">	......</div><div class="line">	try {</div><div class="line">		// &#x521B;&#x5EFA;WindowSurfaceController&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x8FD9;&#x91CC;&#x9762;&#x7684;&#x53C2;&#x6570;&#x6709;Session&#x4E2D;&#x7684;SurfaceSession&#x5BF9;&#x8C61;</div><div class="line">		// &#x4E4B;&#x524D;&#x4E5F;&#x8BF4;&#x8FC7;&#xFF0C;SurfaceSession&#x7528;&#x6765;&#x8FDE;&#x63A5;Surface flingler&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x89C9;&#x5F97;&#x8FD9;&#x91CC;Surface&#x548C;Surface flinger&#x662F;&#x901A;&#x8FC7;SurfaceSession&#x8FDE;&#x63A5;&#x3002;</div><div class="line">		mSurfaceController = new WindowSurfaceController(mSession.mSurfaceSession,</div><div class="line">				attrs.getTitle().toString(),</div><div class="line">				width, height, format, flags, this, windowType, ownerUid);</div><div class="line">		......</div><div class="line">	} catch (OutOfResourcesException e) {</div><div class="line">		Slog.w(TAG, &quot;OutOfResourcesException creating surface&quot;);</div><div class="line">		mService.mRoot.reclaimSomeSurfaceMemory(this, &quot;create&quot;, true);</div><div class="line">		mDrawState = NO_SURFACE;</div><div class="line">		return null;</div><div class="line">	} catch (Exception e) {</div><div class="line">		Slog.e(TAG, &quot;Exception creating surface&quot;, e);</div><div class="line">		mDrawState = NO_SURFACE;</div><div class="line">		return null;</div><div class="line">	}</div><div class="line">	......</div><div class="line">	return mSurfaceController;</div><div class="line">}</div></pre></td></tr></table></figure>
</li>
<li><p>createSurfaceControl&#x65B9;&#x6CD5;&#x901A;&#x8FC7;&#x8C03;&#x7528;WindowStateAnimator&#x7684;createSurfaceLocked&#x65B9;&#x6CD5;&#x53BB;&#x521B;&#x5EFA;WindowSurfaceController</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">WMS:</div><div class="line">private int createSurfaceControl(Surface outSurface, int result, WindowState win,</div><div class="line">		WindowStateAnimator winAnimator) {</div><div class="line">	......</div><div class="line">	try {</div><div class="line">		// &#x521B;&#x5EFA;createSurfaceLocked</div><div class="line">		surfaceController = winAnimator.createSurfaceLocked(win.mAttrs.type, win.mOwnerUid);</div><div class="line">	} </div><div class="line">	......</div><div class="line">	if (surfaceController != null) {</div><div class="line">		// &#x901A;&#x8FC7;Surface.copyFrom&#x65B9;&#x6CD5;&#x83B7;&#x5F97;&#x771F;&#x6B63;&#x7684;Surface</div><div class="line">		surfaceController.getSurface(outSurface);</div><div class="line">		</div><div class="line">	} else {</div><div class="line">		......</div><div class="line">		outSurface.release();</div><div class="line">	}</div><div class="line">	return result;</div><div class="line">}</div></pre></td></tr></table></figure>
</li>
<li><p>WindowSurfaceController&#x7684;&#x521B;&#x5EFA;&#x8FC7;&#x7A0B;&#x4E2D;&#x901A;&#x8FC7;&#x5224;&#x65AD;&#x5F53;&#x524D;&#x662F;&#x5426;&#x5904;&#x4E8E;debug&#x72B6;&#x6001;&#x6765;&#x5224;&#x65AD;&#x521B;&#x5EFA;&#x5177;&#x4F53;&#x7684;SurfaceControl</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">WindowSurfaceController.java:</div><div class="line">public WindowSurfaceController(SurfaceSession s, String name, int w, int h, int format,</div><div class="line">		int flags, WindowStateAnimator animator, int windowType, int ownerUid) {</div><div class="line">	</div><div class="line">	......</div><div class="line">		//&#x521B;&#x5EFA;SurfaceControl&#xFF0C;&#x4ECE;&#x540D;&#x5B57;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#x8FD9;&#x662F;&#x63A7;&#x5236;Surface&#x7684;&#x7C7B;&#xFF0C;&#x5F53;&#x7136;&#x4E86;&#x53C2;&#x6570;&#x4E5F;&#x5305;&#x62EC;&#x4E86;&#x4E4B;&#x524D;&#x7684;SurfaceSession&#x5BF9;&#x8C61;</div><div class="line">		mSurfaceControl = new SurfaceControl(</div><div class="line">				s, name, w, h, format, flags, windowType, ownerUid);</div><div class="line">	......</div><div class="line">}</div></pre></td></tr></table></figure>
</li>
<li><p>SurfaceControl&#x7684;&#x5177;&#x4F53;&#x521B;&#x5EFA;&#x8FC7;&#x7A0B;&#x662F;&#x901A;&#x8FC7;nativeCreate&#x65B9;&#x6CD5;&#x521B;&#x5EFA;&#xFF0C;&#x5F53;&#x7136;&#x4E86;&#x53C2;&#x6570;&#x5305;&#x62EC;&#x4E86;&#x4E4B;&#x524D;&#x7684;SurfaceSession&#x5BF9;&#x8C61;&#xFF0C;&#x4E4B;&#x524D;&#x4E5F;&#x8BF4;&#x8FC7;&#xFF0C;SurfaceSession&#x7528;&#x6765;&#x8FDE;&#x63A5;Surface flingler&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x89C9;&#x5F97;&#x8FD9;&#x91CC;Surface&#x548C;Surface flinger&#x662F;&#x901A;&#x8FC7;SurfaceSession&#x8FDE;&#x63A5;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">SurfaceControl.java:</div><div class="line">public SurfaceControl(SurfaceSession session,</div><div class="line">		String name, int w, int h, int format, int flags)</div><div class="line">				throws OutOfResourcesException {</div><div class="line">	if (session == null) {</div><div class="line">		throw new IllegalArgumentException(&quot;session must not be null&quot;);</div><div class="line">	}</div><div class="line">	if (name == null) {</div><div class="line">		throw new IllegalArgumentException(&quot;name must not be null&quot;);</div><div class="line">	}</div><div class="line"></div><div class="line">	mName = name;</div><div class="line">	// &#x901A;&#x8FC7;native&#x65B9;&#x6CD5;&#x521B;&#x5EFA;&#xFF0C;&#x53C2;&#x6570;&#x662F;&#x540D;&#x79F0; SurfaceSession &#x5BBD; &#x9AD8;&#x7B49;</div><div class="line">	// &#x5177;&#x4F53;&#x521B;&#x5EFA;&#x8FD8;&#x662F;&#x4E0D;&#x6E05;&#x695A;&#x3002;&#x3002;</div><div class="line">	mNativeObject = nativeCreate(session, name, w, h, format, flags);</div><div class="line">	if (mNativeObject == 0) {</div><div class="line">		throw new OutOfResourcesException(</div><div class="line">				&quot;Couldn&apos;t allocate SurfaceControl native object&quot;);</div><div class="line">	}</div><div class="line"></div><div class="line">	mCloseGuard.open(&quot;release&quot;);</div><div class="line">}</div></pre></td></tr></table></figure>
</li>
</ol>
<p>&#x6267;&#x884C;&#x5B8C;relayoutWindow&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x7684;<code>mSurface</code>&#x5BF9;&#x8C61;&#x4E0D;&#x518D;&#x662F;&#x4E00;&#x4E2A;&#x7A7A;&#x6D1E;&#x6D1E;&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x800C;&#x662F;&#x4E00;&#x4E2A;&#x771F;&#x6B63;&#x7684;&#x201D;&#x201C;Surface&#x201D;&#x5BF9;&#x8C61;&#x3002;</p>
</blockquote>
<hr>
<h2 id="6-2-performMeasure&#x65B9;&#x6CD5;"><a href="#6-2-performMeasure&#x65B9;&#x6CD5;" class="headerlink" title="6.2 performMeasure&#x65B9;&#x6CD5;"></a>6.2 performMeasure&#x65B9;&#x6CD5;</h2><blockquote>
<p>performMeasure&#x65B9;&#x6CD5;&#x6267;&#x884C;&#x5F88;&#x7B80;&#x5355;&#xFF0C;&#x5C31;&#x662F;&#x8C03;&#x7528;&#x4E86;View&#x7684;measure&#x65B9;&#x6CD5;&#x3002;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">private void performMeasure(int childWidthMeasureSpec, int childHeightMeasureSpec) {</div><div class="line">	Trace.traceBegin(Trace.TRACE_TAG_VIEW, &quot;measure&quot;);</div><div class="line">	try {</div><div class="line">		//&#x8C03;&#x7528;&#x4E86;View&#x7684;measure&#x65B9;&#x6CD5;&#xFF0C;&#x53C2;&#x6570;&#x662F;&#x957F;&#x548C;&#x5BBD;&#x7684;&#x6D4B;&#x91CF;&#x89C4;&#x683C;</div><div class="line">		mView.measure(childWidthMeasureSpec, childHeightMeasureSpec);</div><div class="line">	} finally {</div><div class="line">		Trace.traceEnd(Trace.TRACE_TAG_VIEW);</div><div class="line">	}</div><div class="line">}</div></pre></td></tr></table></figure></p>
<p>&#x5173;&#x4E8E;View&#x7684;measure&#x8FD9;&#x91CC;&#x4E0D;&#x591A;&#x8BF4;&#x3002;</p>
</blockquote>
<hr>
<h2 id="6-3-performLayout&#x65B9;&#x6CD5;"><a href="#6-3-performLayout&#x65B9;&#x6CD5;" class="headerlink" title="6.3 performLayout&#x65B9;&#x6CD5;"></a>6.3 performLayout&#x65B9;&#x6CD5;</h2><blockquote>
<p>performLayout&#x4E3B;&#x8981;&#x662F;&#x8C03;&#x7528;&#x4E86;View&#x7684;layout&#x65B9;&#x6CD5;&#xFF0C;&#x7531;&#x4E8E;DecorView&#x662F;FrameLayout&#x7684;&#x5B50;&#x7C7B;&#xFF0C;FrameLayout&#x53C8;&#x662F;ViewGroup&#x7684;&#x5B50;&#x7C7B;&#xFF0C;&#x800C;&#x4E14;ViewGroup&#x7684;layout&#x662F;final&#x65B9;&#x6CD5;&#xFF0C;&#x6240;&#x4EE5;&#x6700;&#x540E;&#x8C03;&#x7528;&#x7684;&#x662F;ViewGroup&#x7684;layout&#x65B9;&#x6CD5;&#xFF0C;&#x6EE1;&#x8DB3;&#x6761;&#x4EF6;&#x7684;&#x8BDD;&#xFF0C;&#x6700;&#x540E;&#x4F1A;&#x8C03;&#x7528;View&#x7684;layout&#x65B9;&#x6CD5;&#x3002;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line">private void performLayout(WindowManager.LayoutParams lp, int desiredWindowWidth,</div><div class="line">		int desiredWindowHeight) {</div><div class="line">	mLayoutRequested = false;</div><div class="line">	mScrollMayChange = true;</div><div class="line">	// &#x5728;&#x5E03;&#x5C40;&#x8FC7;&#x7A0B;&#x4E2D;</div><div class="line">	mInLayout = true;</div><div class="line"></div><div class="line">	final View host = mView;</div><div class="line">	if (DEBUG_ORIENTATION || DEBUG_LAYOUT) {</div><div class="line">		Log.v(mTag, &quot;Laying out &quot; + host + &quot; to (&quot; +</div><div class="line">				host.getMeasuredWidth() + &quot;, &quot; + host.getMeasuredHeight() + &quot;)&quot;);</div><div class="line">	}</div><div class="line"></div><div class="line">	Trace.traceBegin(Trace.TRACE_TAG_VIEW, &quot;layout&quot;);</div><div class="line">	try {</div><div class="line">		// &#x8C03;&#x7528;View&#xFF08;decorView&#xFF09;&#x7684;layout&#x65B9;&#x6CD5;</div><div class="line">		host.layout(0, 0, host.getMeasuredWidth(), host.getMeasuredHeight());</div><div class="line">		// &#x4E0D;&#x5728;&#x5E03;&#x5C40;&#x8FC7;&#x7A0B;&#x4E2D;&#x4E86;</div><div class="line">		mInLayout = false;</div><div class="line">		int numViewsRequestingLayout = mLayoutRequesters.size();</div><div class="line">		if (numViewsRequestingLayout &gt; 0) {</div><div class="line">			// &#x8FD9;&#x4E2A;&#x6CE8;&#x91CA;&#x5F88;&#x6E05;&#x695A;&#x4E86;&#xFF0C;&#x8FD9;&#x91CC;&#x5728;&#x5E03;&#x5C40;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#x4E3B;&#x8981;&#x662F;requestLayout()&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x88AB;&#x8C03;&#x7528;&#x4E86;&#x3002;</div><div class="line">			// requestLayout() &#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4F1A;&#x8C03;&#x7528;ViewRootImpl&#x7684;requestLayoutDuringLayout&#x65B9;&#x6CD5;&#xFF0C;&#x5C06;&#x81EA;&#x5DF1;&#x6DFB;&#x52A0;&#x5230;list&#x4E2D;</div><div class="line">			// &#x8FD9;&#x65F6;&#x5019;numViewsRequestingLayout &gt; 0&#x6267;&#x884C;&#x4E0B;&#x9762;&#x7684;&#x64CD;&#x4F5C;</div><div class="line">			// requestLayout() was called during layout.</div><div class="line">			// If no layout-request flags are set on the requesting views, there is no problem.</div><div class="line">			// If some requests are still pending, then we need to clear those flags and do</div><div class="line">			// a full request/measure/layout pass to handle this situation.</div><div class="line">			ArrayList&lt;View&gt; validLayoutRequesters = getValidLayoutRequesters(mLayoutRequesters,</div><div class="line">					false);</div><div class="line">			if (validLayoutRequesters != null) {</div><div class="line">				// Set this flag to indicate that any further requests are happening during</div><div class="line">				// the second pass, which may result in posting those requests to the next</div><div class="line">				// frame instead</div><div class="line">				mHandlingLayoutInLayoutRequest = true;</div><div class="line"></div><div class="line">				// Process fresh layout requests, then measure and layout</div><div class="line">				int numValidRequests = validLayoutRequesters.size();</div><div class="line">				for (int i = 0; i &lt; numValidRequests; ++i) {</div><div class="line">					final View view = validLayoutRequesters.get(i);</div><div class="line">					Log.w(&quot;View&quot;, &quot;requestLayout() improperly called by &quot; + view +</div><div class="line">							&quot; during layout: running second layout pass&quot;);</div><div class="line">					view.requestLayout();</div><div class="line">				}</div><div class="line">				measureHierarchy(host, lp, mView.getContext().getResources(),</div><div class="line">						desiredWindowWidth, desiredWindowHeight);</div><div class="line">				mInLayout = true;</div><div class="line">				host.layout(0, 0, host.getMeasuredWidth(), host.getMeasuredHeight());</div><div class="line"></div><div class="line">				mHandlingLayoutInLayoutRequest = false;</div><div class="line"></div><div class="line">				// Check the valid requests again, this time without checking/clearing the</div><div class="line">				// layout flags, since requests happening during the second pass get noop&apos;d</div><div class="line">				validLayoutRequesters = getValidLayoutRequesters(mLayoutRequesters, true);</div><div class="line">				if (validLayoutRequesters != null) {</div><div class="line">					final ArrayList&lt;View&gt; finalRequesters = validLayoutRequesters;</div><div class="line">					// Post second-pass requests to the next frame</div><div class="line">					getRunQueue().post(new Runnable() {</div><div class="line">						@Override</div><div class="line">						public void run() {</div><div class="line">							int numValidRequests = finalRequesters.size();</div><div class="line">							for (int i = 0; i &lt; numValidRequests; ++i) {</div><div class="line">								final View view = finalRequesters.get(i);</div><div class="line">								Log.w(&quot;View&quot;, &quot;requestLayout() improperly called by &quot; + view +</div><div class="line">										&quot; during second layout pass: posting in next frame&quot;);</div><div class="line">								view.requestLayout();</div><div class="line">							}</div><div class="line">						}</div><div class="line">					});</div><div class="line">				}</div><div class="line">			}</div><div class="line"></div><div class="line">		}</div><div class="line">	} finally {</div><div class="line">		Trace.traceEnd(Trace.TRACE_TAG_VIEW);</div><div class="line">	}</div><div class="line">	mInLayout = false;</div><div class="line">}</div></pre></td></tr></table></figure></p>
</blockquote>
<hr>
<h2 id="6-4-performDraw&#x7684;&#x8FC7;&#x7A0B;"><a href="#6-4-performDraw&#x7684;&#x8FC7;&#x7A0B;" class="headerlink" title="6.4 performDraw&#x7684;&#x8FC7;&#x7A0B;"></a>6.4 performDraw&#x7684;&#x8FC7;&#x7A0B;</h2><blockquote>
<p>&#x524D;&#x9762;&#x8BF4;&#x4E86;&#x90A3;&#x4E48;&#x591A;&#xFF0C;&#x4E5F;&#x6CA1;&#x8F6E;&#x5230;&#x7ED8;&#x5236;&#x7684;&#x8FC7;&#x7A0B;&#x3002;&#x5F53;&#x6D4B;&#x91CF;&#x5B8C;&#x6210;&#xFF0C;&#x5E03;&#x5C40;&#x5B8C;&#x6210;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x4FBF;&#x662F;&#x771F;&#x6B63;&#x7684;&#x7ED8;&#x5236;&#x7684;&#x8FC7;&#x7A0B;&#x2014;&#x2014;performDraw&#x3002;<br>&#x6574;&#x4E2A;&#x7ED8;&#x5236;&#x8FC7;&#x7A0B;&#x5206;&#x4E3A;&#x4E86;&#x4E2D;&#x4E0D;&#x540C;&#x7684;&#x7ED8;&#x5236;&#x8FC7;&#x7A0B;&#xFF0C;&#x6211;&#x770B;&#x4E86;&#x5F88;&#x591A;&#x535A;&#x5BA2;&#xFF0C;&#x57FA;&#x672C;&#x4E0A;&#x5206;&#x6790;&#x7684;&#x90FD;&#x662F;&#x8F6F;&#x4EF6;&#x7ED8;&#x5236;&#x3002;&#x4F46;&#x662F;&#xFF0C;Android 4.0&#x5C31;&#x5DF2;&#x7ECF;<strong>&#x9ED8;&#x8BA4;&#x5F00;&#x542F;&#x786C;&#x4EF6;&#x52A0;&#x901F;</strong>&#x4E86;&#xFF0C;&#x6240;&#x4EE5;&#x8FD9;&#x91CC;&#x91CD;&#x70B9;&#x8BF4;&#x4E0B;&#x786C;&#x4EF6;&#x7ED8;&#x5236;&#xFF08;&#x4E0D;&#x4F1A;&#x6D89;&#x53CA;native&#x5C42;&#xFF09;&#x3002;<br>&#x786C;&#x4EF6;&#x52A0;&#x901F;&#x7684;&#x6E32;&#x67D3;&#x8FC7;&#x7A0B;&#xFF1A;</p>
<ol>
<li><p>&#x5728;ViewRootImpl&#x7684;draw&#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x5982;&#x679C;&#x5F00;&#x542F;&#x4E86;&#x786C;&#x4EF6;&#x52A0;&#x901F;&#x4F1A;&#x8C03;&#x7528;ThreadedRenderer&#x7684;draw&#x65B9;&#x6CD5;&#x53BB;&#x7ED8;&#x5236;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">ViewRootImpl.java:</div><div class="line">private void performDraw() {</div><div class="line">	......</div><div class="line">	try {</div><div class="line">		draw(fullRedrawNeeded);</div><div class="line">	} finally {</div><div class="line">		mIsDrawing = false;</div><div class="line">		Trace.traceEnd(Trace.TRACE_TAG_VIEW);</div><div class="line">	}</div><div class="line">	......</div><div class="line">		try {</div><div class="line">			mWindowSession.finishDrawing(mWindow);</div><div class="line">		} catch (RemoteException e) {</div><div class="line">		}</div><div class="line">}</div><div class="line"></div><div class="line">private void draw(boolean fullRedrawNeeded) {</div><div class="line">	</div><div class="line">	// &#x8BBE;&#x7F6E;&#x5C5E;&#x6027;&#x548C;&#x63A5;&#x53E3;&#x56DE;&#x8C03;&#x90E8;&#x5206;</div><div class="line">	......</div><div class="line">	</div><div class="line">	mAttachInfo.mDrawingTime =</div><div class="line">			mChoreographer.getFrameTimeNanos() / TimeUtils.NANOS_PER_MS;</div><div class="line">	</div><div class="line">	if (!dirty.isEmpty() || mIsAnimating || accessibilityFocusDirty) {</div><div class="line">		// &#x5F00;&#x542F;&#x4E86;&#x786C;&#x4EF6;&#x52A0;&#x901F;&#xFF0C;&#x4E4B;&#x524D;&#x8BF4;&#x8FC7; &#x5982;&#x679C;&#x6CA1;&#x6709;&#x81EA;&#x5DF1;&#x7684;SurfaceView&#x5219;&#x5F00;&#x542F;&#x786C;&#x4EF6;&#x52A0;&#x901F;&#xFF0C;&#x6240;&#x4EE5;&#x6700;&#x7EC8;&#x4F1A;&#x6267;&#x884C;&#x8FD9;&#x90E8;&#x5206;&#x4EE3;&#x7801;</div><div class="line">		if (mAttachInfo.mHardwareRenderer != null &amp;&amp; mAttachInfo.mHardwareRenderer.isEnabled()) {</div><div class="line">			......</div><div class="line">			// ThreadedRenderer&#x7684;draw&#x65B9;&#x6CD5;</div><div class="line">			mAttachInfo.mHardwareRenderer.draw(mView, mAttachInfo, this);</div><div class="line">		} else {</div><div class="line">			......</div><div class="line">			// &#x6CA1;&#x6709;&#x5F00;&#x542F;&#x786C;&#x4EF6;&#x52A0;&#x901F;&#xFF0C;&#x8F6F;&#x4EF6;&#x7ED8;&#x5236;</div><div class="line">			if (!drawSoftware(surface, mAttachInfo, xOffset, yOffset, scalingRequired, dirty)) {</div><div class="line">				return;</div><div class="line">			}</div><div class="line">		}</div><div class="line">	}</div><div class="line">	......</div><div class="line">}</div></pre></td></tr></table></figure>
</li>
<li><p>ThreadedRenderer&#x8C03;&#x7528;updateRootDisplayList&#x66F4;&#x65B0;&#x8DDF;&#x663E;&#x793A;&#x5217;&#x8868;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">ThreadedRenderer.java:</div><div class="line">void draw(View view, AttachInfo attachInfo, HardwareDrawCallbacks callbacks) {</div><div class="line">	attachInfo.mIgnoreDirtyState = true;</div><div class="line"></div><div class="line">	final Choreographer choreographer = attachInfo.mViewRootImpl.mChoreographer;</div><div class="line">	choreographer.mFrameInfo.markDrawStart();</div><div class="line">	// &#x66F4;&#x65B0;&#x6839;&#x663E;&#x793A;&#x5217;&#x8868;</div><div class="line">	updateRootDisplayList(view, callbacks);</div><div class="line"></div><div class="line">	......</div><div class="line">}</div></pre></td></tr></table></figure>
</li>
<li><p>updateRootDisplayList&#x8C03;&#x7528;View.updateDisplayListIfDirty&#x65B9;&#x6CD5;&#x83B7;&#x5F97;RenderNode&#x5BF9;&#x8C61;&#xFF0C;&#x901A;&#x8FC7;DisplayListCanvas.drawRenderNode&#x65B9;&#x6CD5;&#x771F;&#x6B63;&#x7ED8;&#x5236;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">ThreadedRenderer.java:</div><div class="line">private void updateRootDisplayList(View view, HardwareDrawCallbacks callbacks) {</div><div class="line">	updateViewTreeDisplayList(view);</div><div class="line"></div><div class="line">	if (mRootNodeNeedsUpdate || !mRootNode.isValid()) {</div><div class="line">		DisplayListCanvas canvas = mRootNode.start(mSurfaceWidth, mSurfaceHeight);</div><div class="line">		try {</div><div class="line">			final int saveCount = canvas.save();</div><div class="line">			canvas.translate(mInsetLeft, mInsetTop);</div><div class="line">			callbacks.onHardwarePreDraw(canvas);</div><div class="line"></div><div class="line">			canvas.insertReorderBarrier();</div><div class="line">			// view.updateDisplayListIfDirty()&#x8FD9;&#x4E2A;&#x662F;&#x91CD;&#x70B9;&#xFF0C;&#x771F;&#x6B63;&#x7684;&#x5C06;&#x8981;&#x663E;&#x793A;&#x7684;&#x5217;&#x8868;&#x4EA4;&#x7ED9;canvas&#x53BB;&#x7ED8;&#x5236;</div><div class="line">			canvas.drawRenderNode(view.updateDisplayListIfDirty());</div><div class="line">			canvas.insertInorderBarrier();</div><div class="line"></div><div class="line">			callbacks.onHardwarePostDraw(canvas);</div><div class="line">			canvas.restoreToCount(saveCount);</div><div class="line">			mRootNodeNeedsUpdate = false;</div><div class="line">		} finally {</div><div class="line">			mRootNode.end(canvas);</div><div class="line">		}</div><div class="line">	}</div><div class="line">	Trace.traceEnd(Trace.TRACE_TAG_VIEW);</div><div class="line">}</div></pre></td></tr></table></figure>
</li>
<li><p>&#x5173;&#x4E8E;View.updateDisplayListIfDirty()&#x65B9;&#x6CD5;&#xFF0C;&#x6211;&#x7684;&#x7406;&#x89E3;&#x662F;canvas&#x662F;&#x6574;&#x4E2A;&#x753B;&#x5E03;&#xFF0C;&#x901A;&#x8FC7;draw&#xFF0C;dispatchDraw&#x5C06;&#x8981;&#x753B;&#x7684;&#x5185;&#x5BB9;&#x6DFB;&#x52A0;&#x5230;&#x753B;&#x5E03;&#x4E0A;&#xFF0C;&#x901A;&#x8FC7;renderNode.end(canvas)&#x83B7;&#x5F97;&#x5F53;&#x524D;&#x7684;&#x753B;&#x5E03;&#x7684;&#x5185;&#x5BB9;&#xFF0C;&#x6700;&#x7EC8;&#x4EA4;&#x7ED9;GPU&#x7EDF;&#x4E00;&#x53BB;&#x5904;&#x7406;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">View.java:</div><div class="line">public RenderNode updateDisplayListIfDirty() {</div><div class="line">	......</div><div class="line"></div><div class="line">		try {</div><div class="line">			if (layerType == LAYER_TYPE_SOFTWARE) {// &#x8F6F;&#x4EF6;&#x7ED8;&#x5236;</div><div class="line">				buildDrawingCache(true);</div><div class="line">				Bitmap cache = getDrawingCache(true);</div><div class="line">				if (cache != null) {</div><div class="line">					canvas.drawBitmap(cache, 0, 0, mLayerPaint);</div><div class="line">				}</div><div class="line">			} else {</div><div class="line">				computeScroll();</div><div class="line"></div><div class="line">				canvas.translate(-mScrollX, -mScrollY);</div><div class="line">				mPrivateFlags |= PFLAG_DRAWN | PFLAG_DRAWING_CACHE_VALID;</div><div class="line">				mPrivateFlags &amp;= ~PFLAG_DIRTY_MASK;</div><div class="line">				// &#x5982;&#x679C;&#x6CA1;&#x6709;&#x80CC;&#x666F;&#xFF0C;&#x5219;&#x76F4;&#x63A5;&#x8C03;&#x7528;dispatchDraw(canvas)&#xFF0C;&#x5426;&#x5219;&#x8C03;&#x7528;draw(canvas)</div><div class="line">				// Fast path for layouts with no backgrounds</div><div class="line">				if ((mPrivateFlags &amp; PFLAG_SKIP_DRAW) == PFLAG_SKIP_DRAW) {</div><div class="line">					dispatchDraw(canvas);</div><div class="line">					if (mOverlay != null &amp;&amp; !mOverlay.isEmpty()) {</div><div class="line">						mOverlay.getOverlayView().draw(canvas);</div><div class="line">					}</div><div class="line">				} else {</div><div class="line">					draw(canvas);</div><div class="line">				}</div><div class="line">			}</div><div class="line">		} finally {</div><div class="line">			// &#x7ED8;&#x5236;&#x8282;&#x70B9;&#x4FDD;&#x5B58;&#xFF0C;&#x6211;&#x7684;&#x7406;&#x89E3;&#x662F;canvas&#x662F;&#x6574;&#x4E2A;&#x753B;&#x5E03;&#xFF0C;&#x901A;&#x8FC7;draw&#xFF0C;dispatchDraw&#x5C06;&#x8981;&#x753B;&#x7684;&#x4E1C;&#x897F;&#x6DFB;&#x52A0;&#x5230;&#x753B;&#x5E03;&#x4E0A;&#xFF0C;</div><div class="line">			// &#x901A;&#x8FC7;renderNode.end(canvas)&#x4FDD;&#x5B58;&#x753B;&#x5E03;&#x72B6;&#x6001;&#xFF0C;&#x6700;&#x7EC8;&#x4EA4;&#x7ED9;GPU&#x53BB;&#x5904;&#x7406;</div><div class="line">			renderNode.end(canvas);</div><div class="line">			// &#x8BBE;&#x7F6E;alpha&#x7B49;&#x5C5E;&#x6027;</div><div class="line">			setDisplayListProperties(renderNode);</div><div class="line">		}</div><div class="line">	} else {</div><div class="line">		mPrivateFlags |= PFLAG_DRAWN | PFLAG_DRAWING_CACHE_VALID;</div><div class="line">		mPrivateFlags &amp;= ~PFLAG_DIRTY_MASK;</div><div class="line">	}</div><div class="line">	return renderNode;</div><div class="line">}</div></pre></td></tr></table></figure>
</li>
</ol>
<p>&#x8F6F;&#x4EF6;&#x7ED8;&#x5236;&#x8FC7;&#x7A0B;&#xFF1A;<br>drawSoftware&#x76F4;&#x63A5;&#x8C03;&#x7528;&#x4E86;View&#x7684;draw&#x65B9;&#x6CD5;&#xFF0C;&#x901A;&#x8FC7;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x76F4;&#x63A5;&#x7ED8;&#x5236;&#x3002;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">private boolean drawSoftware(Surface surface, AttachInfo attachInfo, int xoff, int yoff,</div><div class="line">		boolean scalingRequired, Rect dirty) {</div><div class="line"></div><div class="line"></div><div class="line">	try {</div><div class="line">	......</div><div class="line">		try {</div><div class="line">			......</div><div class="line">			// &#x771F;&#x6B63;&#x7ED8;&#x5236;&#xFF0C;&#x5728;&#x8FD9;&#x91CC;&#x4E0E;&#x786C;&#x4EF6;&#x6E32;&#x67D3;&#x5BF9;&#x6BD4;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#x8FD9;&#x91CC;&#x9762;&#x53EA;&#x662F;canvas&#x53BB;draw&#x5404;&#x79CD;&#x5185;&#x5BB9;&#x3002;</div><div class="line">			mView.draw(canvas);</div><div class="line">			drawAccessibilityFocusedDrawableIfNeeded(canvas);</div><div class="line">		} finally {</div><div class="line">			if (!attachInfo.mSetIgnoreDirtyState) {</div><div class="line">				// Only clear the flag if it was not set during the mView.draw() call</div><div class="line">				attachInfo.mIgnoreDirtyState = false;</div><div class="line">			}</div><div class="line">		}</div><div class="line">	} finally {</div><div class="line">		......</div><div class="line">	}</div><div class="line">	return true;</div><div class="line">}</div></pre></td></tr></table></figure></p>
</blockquote>
<hr>
<h1 id="7-&#x5199;&#x5728;&#x540E;&#x9762;&#x7684;&#x8BDD;"><a href="#7-&#x5199;&#x5728;&#x540E;&#x9762;&#x7684;&#x8BDD;" class="headerlink" title="7. &#x5199;&#x5728;&#x540E;&#x9762;&#x7684;&#x8BDD;"></a>7. &#x5199;&#x5728;&#x540E;&#x9762;&#x7684;&#x8BDD;</h1><blockquote>
<p>&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x65AD;&#x65AD;&#x7EED;&#x7EED;&#x5199;&#x4E86;&#x5C06;&#x8FD1;&#x4E24;&#x5468;&#x4E86;&#xFF0C;&#x60F3;&#x5927;&#x800C;&#x5168;&#x7684;&#x5168;&#x9762;&#x5206;&#x6790;&#x6240;&#x6709;&#x65B9;&#x6CD5;&#xFF0C;&#x53D1;&#x73B0;&#x4E1C;&#x897F;&#x592A;&#x591A;&#x4E86;&#x6839;&#x672C;&#x4E0D;&#x80FD;&#x4E00;&#x4E0B;&#x5B50;&#x5168;&#x90E8;&#x5206;&#x6790;&#x5B8C;&#x3002;&#x8FD9;&#x91CC;&#x9762;&#x6709;&#x5F88;&#x591A;&#x5730;&#x65B9;&#x90FD;&#x6CA1;&#x6709;&#x5199;&#x51FA;&#x6765;&#xFF0C;&#x5305;&#x62EC;&#x4E86;Choreographer&#xFF08;&#x7F16;&#x821E;&#x8005;&#xFF09;&#xFF0C;View&#x7684;measure&#x3001;layout&#x3001;draw&#x7684;&#x8FC7;&#x7A0B;&#xFF0C;&#x8FD8;&#x6709;&#x5404;&#x79CD;&#x7EC6;&#x8282;&#x7684;&#x5B9E;&#x73B0;&#x4EE5;&#x53CA;&#x5E95;&#x5C42;native&#x65B9;&#x6CD5;&#x7684;&#x5177;&#x4F53;&#x5B9E;&#x73B0;&#x3002;<br>&#x8DEF;&#x6F2B;&#x6F2B;&#x5176;&#x4FEE;&#x8FDC;&#x516E;&#xFF0C;&#x540C;&#x5FD7;&#x4ECD;&#x9700;&#x52AA;&#x529B;&#x3002;<br><img src="http://upload-images.jianshu.io/upload_images/5720362-28ce1fb057e1ca1a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
</blockquote>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/11/16/Activity从创建到显示的整个过程/" rel="next" title="Activity从创建到显示的整个过程">
                <i class="fa fa-chevron-left"></i> Activity从创建到显示的整个过程
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/12/13/View的测量、布局和绘制过程/" rel="prev" title="View的测量、布局和绘制过程">
                View的测量、布局和绘制过程 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/favicon.png"
               alt="Nick Kang" />
          <p class="site-author-name" itemprop="name">Nick Kang</p>
          <p class="site-description motion-element" itemprop="description">风轻云淡，勿忘本心</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">17</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#写在前面的话"><span class="nav-number">1.</span> <span class="nav-text">写在前面的话</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#1-从WindowManager的addView说起"><span class="nav-number">2.</span> <span class="nav-text">1. 从WindowManager的addView说起</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-WindowManagerGlobal的addView方法"><span class="nav-number">3.</span> <span class="nav-text">2. WindowManagerGlobal的addView方法</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-ViewRootImpl的setView方法"><span class="nav-number">4.</span> <span class="nav-text">3. ViewRootImpl的setView方法</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-Session的addToDisplay"><span class="nav-number">5.</span> <span class="nav-text">4. Session的addToDisplay</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#6-Choreographer的TraversalRunnable异步方法执行"><span class="nav-number">6.</span> <span class="nav-text">6. Choreographer的TraversalRunnable异步方法执行</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#6-1-relayoutWindow的过程"><span class="nav-number">6.1.</span> <span class="nav-text">6.1 relayoutWindow的过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-2-performMeasure方法"><span class="nav-number">6.2.</span> <span class="nav-text">6.2 performMeasure方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-3-performLayout方法"><span class="nav-number">6.3.</span> <span class="nav-text">6.3 performLayout方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-4-performDraw的过程"><span class="nav-number">6.4.</span> <span class="nav-text">6.4 performDraw的过程</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#7-写在后面的话"><span class="nav-number">7.</span> <span class="nav-text">7. 写在后面的话</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Nick Kang</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  




  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

  


</body>
</html>
